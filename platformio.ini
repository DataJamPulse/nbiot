; PlatformIO Project Configuration File
; M5Stack AtomS3 DTU-NB-IoT with SIM7028
; NB-IoT JamBox Probe Counter Firmware

[env:m5stack-atoms3]
platform = espressif32
board = m5stack-atoms3
framework = arduino
monitor_speed = 115200
upload_port = /dev/cu.usbmodem1101
monitor_port = /dev/cu.usbmodem1101

; Exclude provisioning firmware from production build
build_src_filter = +<*> -<provisioning_main.cpp>

; Build flags for debugging and features
build_flags =
    -DCORE_DEBUG_LEVEL=3
    -DARDUINO_USB_CDC_ON_BOOT=1
    -DCONFIG_ARDUHAL_LOG_COLORS=1
    -DCONFIG_BOOTLOADER_APP_ROLLBACK_ENABLE=1

; Library dependencies
lib_deps =
    fastled/FastLED@^3.6.0
    h2zero/NimBLE-Arduino@^1.4.1
    ; ArduinoOTA is included in ESP32 Arduino core

; Monitor filters for cleaner output
monitor_filters =
    direct
    esp32_exception_decoder

; OTA partition scheme - allows for OTA updates
board_build.partitions = min_spiffs.csv

; =============================================================================
; PROVISIONING FIRMWARE ENVIRONMENT
; =============================================================================
; This environment builds a minimal firmware for manufacturing provisioning.
; It compiles ONLY provisioning_main.cpp (not main.cpp) and excludes BLE
; libraries to reduce size and complexity.
;
; Usage:
;   pio run -e provisioning              # Build provisioning firmware
;   pio run -e provisioning -t upload    # Flash provisioning firmware
;
; The provisioning firmware is used during device manufacturing to:
;   - Test hardware functionality (LED, modem, serial)
;   - Register device with backend
;   - Write device credentials to NVS
;   - Verify cellular connectivity
; =============================================================================

[env:provisioning]
platform = espressif32
board = m5stack-atoms3
framework = arduino
monitor_speed = 115200
upload_port = /dev/cu.usbmodem1101
monitor_port = /dev/cu.usbmodem1101

; Only compile provisioning_main.cpp, exclude everything else
build_src_filter = -<*> +<provisioning_main.cpp>

; Minimal build flags for provisioning
build_flags =
    -DCORE_DEBUG_LEVEL=3
    -DARDUINO_USB_CDC_ON_BOOT=1

; Minimal library dependencies (no BLE needed for provisioning)
lib_deps =
    fastled/FastLED@^3.6.0

; Monitor filters
monitor_filters =
    direct
    esp32_exception_decoder

; Use same partition scheme as production
board_build.partitions = min_spiffs.csv
