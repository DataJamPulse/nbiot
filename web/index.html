<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Store Insights | DataJam</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        @font-face {
            font-family: 'Abeat';
            src: url('fonts/abeat-regular.otf') format('opentype'),
                 url('fonts/abeat-regular.ttf') format('truetype');
            font-weight: 400;
            font-style: normal;
            font-display: swap;
        }

        :root {
            --dj-black: #0A0C11;
            --dj-white: #FEFAF9;
            --dj-pink: #E62F6E;
            --dj-orange: #E94B52;

            --chart-purple: #5E2BFF;
            --chart-teal: #15E0BC;
            --chart-green: #78C534;
            --chart-yellow: #EDBA06;

            --bg-deep: #050608;
            --bg-surface: #12141A;
            --bg-elevated: #1A1D24;

            --text-white: var(--dj-white);
            --text-primary: #E8E6E4;
            --text-secondary: #9A9896;
            --text-muted: #5A5856;

            --status-up: var(--chart-teal);
            --status-down: var(--dj-orange);

            --radius-sm: 8px;
            --radius-md: 16px;
            --radius-lg: 24px;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        html { font-size: 16px; }

        body {
            font-family: 'Poppins', sans-serif;
            font-weight: 300;
            background: var(--bg-deep);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.5;
        }

        /* Gradient background */
        body::before {
            content: '';
            position: fixed;
            inset: 0;
            background:
                radial-gradient(ellipse 80% 50% at 20% 0%, rgba(230, 47, 110, 0.06) 0%, transparent 50%),
                radial-gradient(ellipse 60% 40% at 80% 100%, rgba(233, 75, 82, 0.04) 0%, transparent 50%);
            pointer-events: none;
        }

        .app {
            position: relative;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* ==================== HEADER ==================== */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 0 32px;
        }

        .brand {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .brand-mark {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--dj-pink), var(--dj-orange));
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }

        .brand h1 {
            font-family: 'Abeat', 'Poppins', sans-serif;
            font-size: 20px;
            font-weight: 400;
            color: var(--text-white);
        }

        .brand h1 span {
            background: linear-gradient(90deg, var(--dj-pink), var(--dj-orange));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .store-selector {
            background: var(--bg-surface);
            border: 1px solid rgba(255,255,255,0.08);
            border-radius: var(--radius-sm);
            padding: 10px 14px;
            color: var(--text-primary);
            font-family: inherit;
            font-size: 13px;
            cursor: pointer;
        }

        .last-updated {
            font-size: 11px;
            color: var(--text-muted);
        }

        .live-dot {
            display: inline-block;
            width: 6px;
            height: 6px;
            background: var(--chart-teal);
            border-radius: 50%;
            margin-right: 6px;
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.4; }
        }

        /* ==================== HERO STATS ==================== */
        .hero {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
            margin-bottom: 32px;
        }

        .hero-card {
            background: var(--bg-surface);
            border-radius: var(--radius-lg);
            padding: 28px;
            border: 1px solid rgba(255,255,255,0.04);
        }

        .hero-card.primary {
            grid-column: span 2;
            background: linear-gradient(135deg, rgba(230, 47, 110, 0.12), rgba(233, 75, 82, 0.08));
            border-color: rgba(230, 47, 110, 0.2);
        }

        .hero-label {
            font-size: 12px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-muted);
            margin-bottom: 8px;
        }

        .hero-value {
            font-size: 48px;
            font-weight: 600;
            color: var(--text-white);
            line-height: 1;
            margin-bottom: 12px;
        }

        .hero-card.primary .hero-value {
            font-size: 64px;
        }

        .hero-comparison {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-size: 13px;
            font-weight: 500;
            padding: 4px 10px;
            border-radius: 20px;
        }

        .hero-comparison.up {
            background: rgba(21, 224, 188, 0.12);
            color: var(--chart-teal);
        }

        .hero-comparison.down {
            background: rgba(233, 75, 82, 0.12);
            color: var(--dj-orange);
        }

        .hero-comparison.neutral {
            background: rgba(255, 255, 255, 0.06);
            color: var(--text-secondary);
        }

        .hero-sublabel {
            font-size: 11px;
            color: var(--text-muted);
            margin-top: 8px;
        }

        /* ==================== CHART SECTION ==================== */
        .section {
            margin-bottom: 32px;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .section-title {
            font-size: 16px;
            font-weight: 500;
            color: var(--text-white);
        }

        .section-tabs {
            display: flex;
            gap: 4px;
            background: var(--bg-surface);
            border-radius: var(--radius-sm);
            padding: 4px;
        }

        .section-tab {
            padding: 6px 14px;
            font-size: 12px;
            font-weight: 500;
            color: var(--text-muted);
            background: transparent;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .section-tab.active {
            background: var(--bg-elevated);
            color: var(--text-white);
        }

        .section-tab:hover:not(.active) {
            color: var(--text-secondary);
        }

        .chart-container {
            background: var(--bg-surface);
            border-radius: var(--radius-lg);
            padding: 24px;
            border: 1px solid rgba(255,255,255,0.04);
        }

        /* Simple bar chart */
        .hourly-chart {
            display: flex;
            align-items: flex-end;
            gap: 4px;
            height: 180px;
            padding-top: 20px;
        }

        .chart-bar-wrapper {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            height: 100%;
        }

        .chart-bar {
            width: 100%;
            max-width: 32px;
            background: linear-gradient(180deg, var(--dj-pink), var(--dj-orange));
            border-radius: 4px 4px 0 0;
            min-height: 4px;
            transition: height 0.3s ease;
            position: relative;
        }

        .chart-bar:hover {
            opacity: 0.85;
        }

        .chart-bar::after {
            content: attr(data-value);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            padding: 4px 8px;
            background: var(--bg-elevated);
            border-radius: 4px;
            font-size: 11px;
            font-weight: 500;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s ease;
        }

        .chart-bar:hover::after {
            opacity: 1;
        }

        .chart-label {
            font-size: 10px;
            color: var(--text-muted);
            margin-top: 8px;
            text-align: center;
        }

        .chart-empty {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 180px;
            color: var(--text-muted);
        }

        .chart-empty-icon {
            font-size: 32px;
            margin-bottom: 12px;
            opacity: 0.5;
        }

        /* ==================== ENGAGEMENT SECTION ==================== */
        .engagement-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
        }

        .engagement-card {
            background: var(--bg-surface);
            border-radius: var(--radius-md);
            padding: 20px;
            text-align: center;
            border: 1px solid rgba(255,255,255,0.04);
            transition: border-color 0.2s ease;
        }

        .engagement-card:hover {
            border-color: rgba(255,255,255,0.1);
        }

        .engagement-icon {
            font-size: 28px;
            margin-bottom: 12px;
        }

        .engagement-value {
            font-size: 28px;
            font-weight: 600;
            color: var(--text-white);
            margin-bottom: 4px;
        }

        .engagement-label {
            font-size: 11px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.04em;
            color: var(--text-muted);
            margin-bottom: 4px;
        }

        .engagement-desc {
            font-size: 11px;
            color: var(--text-secondary);
        }

        .engagement-card[data-type="passerby"] .engagement-value { color: var(--chart-purple); }
        .engagement-card[data-type="curious"] .engagement-value { color: var(--chart-teal); }
        .engagement-card[data-type="engaged"] .engagement-value { color: var(--chart-green); }
        .engagement-card[data-type="loyal"] .engagement-value { color: var(--chart-yellow); }

        /* ==================== DEVICE STATUS ==================== */
        .devices-section {
            background: var(--bg-surface);
            border-radius: var(--radius-lg);
            padding: 24px;
            border: 1px solid rgba(255,255,255,0.04);
        }

        .devices-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .devices-title {
            font-size: 14px;
            font-weight: 500;
            color: var(--text-white);
        }

        .devices-count {
            font-size: 12px;
            color: var(--text-muted);
        }

        .device-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 14px 0;
            border-bottom: 1px solid rgba(255,255,255,0.04);
        }

        .device-row:last-child {
            border-bottom: none;
            padding-bottom: 0;
        }

        .device-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .device-status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }

        .device-status-dot.online {
            background: var(--chart-teal);
            box-shadow: 0 0 8px var(--chart-teal);
        }

        .device-status-dot.warning {
            background: var(--chart-yellow);
        }

        .device-status-dot.offline {
            background: var(--dj-orange);
        }

        .device-name {
            font-size: 14px;
            font-weight: 500;
            color: var(--text-white);
        }

        .device-location {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .device-stats {
            display: flex;
            gap: 24px;
            align-items: center;
        }

        .device-stat {
            text-align: right;
        }

        .device-stat-value {
            font-size: 14px;
            font-weight: 500;
            color: var(--text-primary);
        }

        .device-stat-label {
            font-size: 10px;
            color: var(--text-muted);
        }

        .btn-view {
            padding: 8px 14px;
            font-size: 11px;
            font-weight: 500;
            background: var(--bg-elevated);
            border: 1px solid rgba(255,255,255,0.08);
            border-radius: var(--radius-sm);
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-view:hover {
            background: var(--bg-hover, #22262F);
            color: var(--text-white);
            border-color: var(--dj-pink);
        }

        /* ==================== FOOTER ==================== */
        .footer {
            text-align: center;
            padding: 32px 0;
            font-size: 11px;
            color: var(--text-muted);
        }

        /* ==================== LOADING ==================== */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 48px;
            color: var(--text-muted);
        }

        .spinner {
            width: 24px;
            height: 24px;
            border: 2px solid var(--bg-elevated);
            border-top-color: var(--dj-pink);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-right: 12px;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        /* ==================== MODAL ==================== */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(5, 6, 8, 0.9);
            backdrop-filter: blur(8px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
        }

        .modal {
            background: var(--bg-surface);
            border-radius: var(--radius-lg);
            width: 100%;
            max-width: 560px;
            max-height: 85vh;
            overflow-y: auto;
            border: 1px solid rgba(255,255,255,0.06);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 24px;
            border-bottom: 1px solid rgba(255,255,255,0.04);
        }

        .modal-title {
            font-size: 18px;
            font-weight: 500;
            color: var(--text-white);
        }

        .modal-close {
            width: 32px;
            height: 32px;
            background: var(--bg-elevated);
            border: none;
            border-radius: var(--radius-sm);
            color: var(--text-muted);
            font-size: 18px;
            cursor: pointer;
        }

        .modal-close:hover {
            color: var(--text-white);
        }

        .modal-body {
            padding: 24px;
        }

        .modal-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-bottom: 24px;
        }

        .modal-stat {
            background: var(--bg-deep);
            border-radius: var(--radius-sm);
            padding: 16px;
            text-align: center;
        }

        .modal-stat-value {
            font-size: 20px;
            font-weight: 600;
            color: var(--text-white);
        }

        .modal-stat-label {
            font-size: 10px;
            color: var(--text-muted);
            text-transform: uppercase;
            margin-top: 4px;
        }

        .readings-list {
            max-height: 240px;
            overflow-y: auto;
        }

        .reading-row {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid rgba(255,255,255,0.04);
            font-size: 13px;
        }

        .reading-time {
            color: var(--text-secondary);
        }

        .reading-value {
            color: var(--text-white);
            font-weight: 500;
        }

        /* ==================== RESPONSIVE ==================== */
        @media (max-width: 900px) {
            .hero {
                grid-template-columns: 1fr;
            }
            .hero-card.primary {
                grid-column: span 1;
            }
            .engagement-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 600px) {
            .app { padding: 16px; }
            .header { flex-direction: column; gap: 16px; align-items: flex-start; }
            .hero-value { font-size: 36px; }
            .hero-card.primary .hero-value { font-size: 48px; }
            .engagement-grid { grid-template-columns: 1fr 1fr; }
            .device-stats { display: none; }
        }
    </style>
</head>
<body>
    <div class="app">
        <header class="header">
            <div class="brand">
                <div class="brand-mark">üìä</div>
                <h1>My Store <span>Insights</span></h1>
            </div>
            <div class="header-right">
                <select class="store-selector" id="storeSelector">
                    <option value="all">All Locations</option>
                </select>
                <span class="last-updated">
                    <span class="live-dot"></span>
                    <span id="lastUpdated">Loading...</span>
                </span>
            </div>
        </header>

        <!-- Hero Stats -->
        <section class="hero" id="heroStats">
            <div class="hero-card primary">
                <div class="hero-label">Visitors Today</div>
                <div class="hero-value" id="heroVisitors">‚Äî</div>
                <div class="hero-comparison neutral" id="heroComparison">
                    <span>‚Äî</span>
                </div>
                <div class="hero-sublabel">Unique devices detected near your location</div>
            </div>
            <div class="hero-card">
                <div class="hero-label">Peak Hour</div>
                <div class="hero-value" id="heroPeakHour">‚Äî</div>
                <div class="hero-sublabel" id="heroPeakCount">‚Äî</div>
            </div>
        </section>

        <!-- Hourly Traffic Chart -->
        <section class="section">
            <div class="section-header">
                <h2 class="section-title">Traffic Throughout the Day</h2>
                <div class="section-tabs">
                    <button class="section-tab active" data-range="today">Today</button>
                    <button class="section-tab" data-range="yesterday">Yesterday</button>
                    <button class="section-tab" data-range="week">This Week</button>
                </div>
            </div>
            <div class="chart-container">
                <div class="hourly-chart" id="hourlyChart">
                    <div class="loading"><div class="spinner"></div> Loading chart...</div>
                </div>
            </div>
        </section>

        <!-- Engagement Breakdown -->
        <section class="section">
            <div class="section-header">
                <h2 class="section-title">Visitor Engagement</h2>
            </div>
            <div class="engagement-grid" id="engagementGrid">
                <div class="engagement-card" data-type="passerby">
                    <div class="engagement-icon">üö∂</div>
                    <div class="engagement-value" id="engPasserby">‚Äî</div>
                    <div class="engagement-label">Drive-by</div>
                    <div class="engagement-desc">Passed by quickly</div>
                </div>
                <div class="engagement-card" data-type="curious">
                    <div class="engagement-icon">üëÄ</div>
                    <div class="engagement-value" id="engCurious">‚Äî</div>
                    <div class="engagement-label">Curious</div>
                    <div class="engagement-desc">Stopped briefly (1-5 min)</div>
                </div>
                <div class="engagement-card" data-type="engaged">
                    <div class="engagement-icon">üõçÔ∏è</div>
                    <div class="engagement-value" id="engEngaged">‚Äî</div>
                    <div class="engagement-label">Engaged</div>
                    <div class="engagement-desc">Stayed a while (5-10 min)</div>
                </div>
                <div class="engagement-card" data-type="loyal">
                    <div class="engagement-icon">‚≠ê</div>
                    <div class="engagement-value" id="engLoyal">‚Äî</div>
                    <div class="engagement-label">Loyal</div>
                    <div class="engagement-desc">Spent 10+ minutes</div>
                </div>
            </div>
            <p style="font-size: 11px; color: var(--text-muted); margin-top: 12px; text-align: center;">
                Based on how long visitors' phones were detected near your location
            </p>
        </section>

        <!-- Device Status -->
        <section class="section">
            <div class="devices-section">
                <div class="devices-header">
                    <span class="devices-title">Your Sensors</span>
                    <span class="devices-count" id="devicesCount">‚Äî</span>
                </div>
                <div id="devicesList">
                    <div class="loading"><div class="spinner"></div> Loading devices...</div>
                </div>
            </div>
        </section>

        <footer class="footer">
            Powered by DataJam ‚Ä¢ Data updates every 5 minutes
        </footer>
    </div>

    <div id="modal"></div>

    <script>
        const API_BASE = '/.netlify/functions/nbiot-api';

        let allDevices = [];
        let hourlyData = [];

        // ==================== LOAD DATA ====================
        async function loadDashboard() {
            try {
                const [devicesRes, statsRes, hourlyRes] = await Promise.all([
                    fetch(`${API_BASE}/devices`),
                    fetch(`${API_BASE}/stats`),
                    fetch(`${API_BASE}/hourly?days=2`)
                ]);

                const devicesData = await devicesRes.json();
                const statsData = await statsRes.json();
                const hourlyDataRes = await hourlyRes.json();

                allDevices = devicesData.devices || [];
                hourlyData = hourlyDataRes.hourly || [];

                // Update store selector
                updateStoreSelector(allDevices);

                // Update stats
                updateHeroStats(statsData);

                // Update chart
                updateHourlyChart('today');

                // Update engagement (currently firmware sends 0, show placeholder)
                updateEngagement(statsData);

                // Update devices list
                updateDevicesList(allDevices);

                // Update timestamp
                document.getElementById('lastUpdated').textContent = 'Just now';

            } catch (err) {
                console.error('Failed to load dashboard:', err);
                document.getElementById('heroVisitors').textContent = 'Error';
            }
        }

        function updateStoreSelector(devices) {
            const selector = document.getElementById('storeSelector');
            selector.innerHTML = '<option value="all">All Locations</option>';

            devices.forEach(d => {
                if (d.device_id.startsWith('JBNB')) {
                    const opt = document.createElement('option');
                    opt.value = d.device_id;
                    opt.textContent = d.location_name || d.device_id;
                    selector.appendChild(opt);
                }
            });
        }

        function updateHeroStats(stats) {
            const today = stats.today || {};
            const visitors = today.total_unique || 0;

            document.getElementById('heroVisitors').textContent = visitors.toLocaleString();

            // Calculate comparison (simplified - would need yesterday's data)
            const compEl = document.getElementById('heroComparison');
            if (visitors > 0) {
                compEl.className = 'hero-comparison neutral';
                compEl.innerHTML = `<span>üìà ${today.readings_count || 0} readings today</span>`;
            }

            // Find peak hour from hourly data
            const todayHours = hourlyData.filter(h => {
                const date = new Date(h.hour);
                const now = new Date();
                return date.toDateString() === now.toDateString();
            });

            if (todayHours.length > 0) {
                const peak = todayHours.reduce((max, h) =>
                    h.impressions > max.impressions ? h : max, todayHours[0]);

                const peakHour = new Date(peak.hour).getHours();
                const peakHourStr = peakHour === 0 ? '12 AM' :
                    peakHour < 12 ? `${peakHour} AM` :
                    peakHour === 12 ? '12 PM' : `${peakHour - 12} PM`;

                document.getElementById('heroPeakHour').textContent = peakHourStr;
                document.getElementById('heroPeakCount').textContent =
                    `${peak.impressions.toLocaleString()} visitors`;
            }
        }

        function updateHourlyChart(range) {
            const chartEl = document.getElementById('hourlyChart');
            const now = new Date();
            let filteredData = [];

            if (range === 'today') {
                filteredData = hourlyData.filter(h => {
                    const date = new Date(h.hour);
                    return date.toDateString() === now.toDateString();
                });
            } else if (range === 'yesterday') {
                const yesterday = new Date(now);
                yesterday.setDate(yesterday.getDate() - 1);
                filteredData = hourlyData.filter(h => {
                    const date = new Date(h.hour);
                    return date.toDateString() === yesterday.toDateString();
                });
            } else {
                filteredData = hourlyData;
            }

            if (filteredData.length === 0) {
                chartEl.innerHTML = `
                    <div class="chart-empty">
                        <div class="chart-empty-icon">üìä</div>
                        <div>No data for this period yet</div>
                    </div>
                `;
                return;
            }

            const maxVal = Math.max(...filteredData.map(h => h.impressions), 1);

            if (range === 'week') {
                // Aggregate by day for week view
                const dailyMap = {};
                filteredData.forEach(h => {
                    const date = new Date(h.hour);
                    const dayKey = date.toLocaleDateString('en-US', { weekday: 'short' });
                    if (!dailyMap[dayKey]) dailyMap[dayKey] = 0;
                    dailyMap[dayKey] += h.impressions;
                });

                const dailyData = Object.entries(dailyMap);
                const dailyMax = Math.max(...dailyData.map(d => d[1]), 1);

                chartEl.innerHTML = dailyData.map(([day, impressions]) => {
                    const heightPct = Math.max(5, (impressions / dailyMax) * 100);
                    return `
                        <div class="chart-bar-wrapper">
                            <div class="chart-bar" style="height: ${heightPct}%" data-value="${impressions.toLocaleString()} visitors"></div>
                            <div class="chart-label">${day}</div>
                        </div>
                    `;
                }).join('');
            } else {
                // Show hourly for today/yesterday
                // Fill in missing hours with 0
                const hoursMap = {};
                for (let i = 0; i < 24; i++) {
                    hoursMap[i] = 0;
                }
                filteredData.forEach(h => {
                    const hour = new Date(h.hour).getHours();
                    hoursMap[hour] = h.impressions;
                });

                chartEl.innerHTML = Object.entries(hoursMap).map(([hour, impressions]) => {
                    const heightPct = Math.max(2, (impressions / maxVal) * 100);
                    const hourNum = parseInt(hour);
                    const hourLabel = hourNum === 0 ? '12a' :
                        hourNum < 12 ? `${hourNum}a` :
                        hourNum === 12 ? '12p' : `${hourNum - 12}p`;

                    // Only show every 3rd label on mobile
                    const showLabel = hourNum % 3 === 0;

                    return `
                        <div class="chart-bar-wrapper">
                            <div class="chart-bar" style="height: ${heightPct}%" data-value="${impressions.toLocaleString()} visitors at ${hourLabel}"></div>
                            <div class="chart-label">${showLabel ? hourLabel : ''}</div>
                        </div>
                    `;
                }).join('');
            }
        }

        function updateEngagement(stats) {
            const today = stats.today || {};

            // Note: firmware currently sends 0 for dwell time
            // Show the values we have, or placeholder
            const dwell0_1 = today.dwell_0_1 || 0;
            const dwell1_5 = today.dwell_1_5 || 0;
            const dwell5_10 = today.dwell_5_10 || 0;
            const dwell10plus = today.dwell_10plus || 0;

            const hasData = dwell0_1 + dwell1_5 + dwell5_10 + dwell10plus > 0;

            if (hasData) {
                document.getElementById('engPasserby').textContent = dwell0_1.toLocaleString();
                document.getElementById('engCurious').textContent = dwell1_5.toLocaleString();
                document.getElementById('engEngaged').textContent = dwell5_10.toLocaleString();
                document.getElementById('engLoyal').textContent = dwell10plus.toLocaleString();
            } else {
                // Estimate from unique counts (temporary until firmware fixed)
                const unique = today.total_unique || 0;
                if (unique > 0) {
                    // Rough estimate: most are drive-by
                    document.getElementById('engPasserby').textContent = Math.round(unique * 0.6).toLocaleString();
                    document.getElementById('engCurious').textContent = Math.round(unique * 0.25).toLocaleString();
                    document.getElementById('engEngaged').textContent = Math.round(unique * 0.1).toLocaleString();
                    document.getElementById('engLoyal').textContent = Math.round(unique * 0.05).toLocaleString();

                    // Add note that this is estimated
                    document.querySelector('.engagement-grid').insertAdjacentHTML('afterend',
                        '<p style="font-size: 10px; color: var(--chart-yellow); margin-top: 8px; text-align: center;">‚ö†Ô∏è Estimated values - sensor upgrade pending</p>');
                }
            }
        }

        function updateDevicesList(devices) {
            const listEl = document.getElementById('devicesList');
            const jbnbDevices = devices.filter(d => d.device_id.startsWith('JBNB'));

            document.getElementById('devicesCount').textContent =
                `${jbnbDevices.length} sensor${jbnbDevices.length !== 1 ? 's' : ''}`;

            if (jbnbDevices.length === 0) {
                listEl.innerHTML = '<div style="padding: 24px; text-align: center; color: var(--text-muted);">No sensors configured</div>';
                return;
            }

            listEl.innerHTML = jbnbDevices.map(d => `
                <div class="device-row">
                    <div class="device-info">
                        <div class="device-status-dot ${d.connection_status}"></div>
                        <div>
                            <div class="device-name">${d.location_name || d.device_id}</div>
                            <div class="device-location">${d.connection_status === 'online' ? 'Active' : d.last_seen_ago}</div>
                        </div>
                    </div>
                    <div class="device-stats">
                        <div class="device-stat">
                            <div class="device-stat-value">${d.last_signal_dbm ? d.last_signal_dbm + ' dBm' : '‚Äî'}</div>
                            <div class="device-stat-label">Signal</div>
                        </div>
                        <div class="device-stat">
                            <div class="device-stat-value">v${d.firmware_version || '‚Äî'}</div>
                            <div class="device-stat-label">Version</div>
                        </div>
                    </div>
                    <button class="btn-view" onclick="showDeviceDetail('${d.device_id}')">Details</button>
                </div>
            `).join('');
        }

        async function showDeviceDetail(deviceId) {
            const modal = document.getElementById('modal');
            modal.innerHTML = `
                <div class="modal-overlay" onclick="if(event.target===this)closeModal()">
                    <div class="modal">
                        <div class="modal-header">
                            <div class="modal-title">Loading...</div>
                            <button class="modal-close" onclick="closeModal()">√ó</button>
                        </div>
                        <div class="modal-body">
                            <div class="loading"><div class="spinner"></div></div>
                        </div>
                    </div>
                </div>
            `;

            try {
                const res = await fetch(`${API_BASE}/device/${deviceId}`);
                const data = await res.json();
                const { device, recent_readings } = data;

                // Calculate today's totals for this device
                const todayReadings = recent_readings.filter(r => {
                    const date = new Date(r.timestamp);
                    return date.toDateString() === new Date().toDateString();
                });

                const todayImpressions = todayReadings.reduce((sum, r) => sum + (r.impressions || 0), 0);
                const todayUnique = todayReadings.reduce((sum, r) => sum + (r.unique_count || 0), 0);

                modal.innerHTML = `
                    <div class="modal-overlay" onclick="if(event.target===this)closeModal()">
                        <div class="modal">
                            <div class="modal-header">
                                <div class="modal-title">${device.location_name || device.device_id}</div>
                                <button class="modal-close" onclick="closeModal()">√ó</button>
                            </div>
                            <div class="modal-body">
                                <div class="modal-stats">
                                    <div class="modal-stat">
                                        <div class="modal-stat-value">${todayImpressions.toLocaleString()}</div>
                                        <div class="modal-stat-label">Today's Visitors</div>
                                    </div>
                                    <div class="modal-stat">
                                        <div class="modal-stat-value">${todayUnique.toLocaleString()}</div>
                                        <div class="modal-stat-label">Unique</div>
                                    </div>
                                    <div class="modal-stat">
                                        <div class="modal-stat-value">${device.last_signal_dbm || '‚Äî'}</div>
                                        <div class="modal-stat-label">Signal (dBm)</div>
                                    </div>
                                </div>

                                <div style="margin-bottom: 16px;">
                                    <div style="font-size: 12px; font-weight: 500; color: var(--text-muted); margin-bottom: 8px;">Recent Activity</div>
                                    <div class="readings-list">
                                        ${recent_readings.length === 0
                                            ? '<div style="padding: 16px; text-align: center; color: var(--text-muted);">No readings yet</div>'
                                            : recent_readings.slice(0, 10).map(r => `
                                                <div class="reading-row">
                                                    <span class="reading-time">${new Date(r.timestamp).toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'})}</span>
                                                    <span class="reading-value">${r.impressions} visitors (${r.unique_count} unique)</span>
                                                </div>
                                            `).join('')
                                        }
                                    </div>
                                </div>

                                <div style="display: flex; gap: 8px; padding-top: 16px; border-top: 1px solid rgba(255,255,255,0.06);">
                                    <button class="btn-view" style="flex: 1; justify-content: center;" onclick="closeModal()">Close</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

            } catch (err) {
                modal.innerHTML = '';
                alert('Failed to load device details');
            }
        }

        function closeModal() {
            document.getElementById('modal').innerHTML = '';
        }

        // Tab switching
        document.querySelectorAll('.section-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.section-tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                updateHourlyChart(tab.dataset.range);
            });
        });

        // Initialize
        loadDashboard();

        // Auto-refresh every 2 minutes
        setInterval(() => {
            loadDashboard();
        }, 120000);
    </script>
</body>
</html>
