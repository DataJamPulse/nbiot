<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Store Insights | DataJam</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --dj-black: #0A0C11;
            --dj-white: #FEFAF9;
            --dj-pink: #E62F6E;
            --dj-orange: #E94B52;

            --chart-purple: #5E2BFF;
            --chart-teal: #15E0BC;
            --chart-green: #78C534;
            --chart-yellow: #EDBA06;

            --bg-deep: #050608;
            --bg-surface: #12141A;
            --bg-elevated: #1A1D24;

            --text-white: var(--dj-white);
            --text-primary: #E8E6E4;
            --text-secondary: #9A9896;
            --text-muted: #5A5856;

            --radius-sm: 8px;
            --radius-md: 16px;
            --radius-lg: 24px;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        html { font-size: 16px; }

        body {
            font-family: 'Poppins', sans-serif;
            font-weight: 300;
            background: var(--bg-deep);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.5;
        }

        body::before {
            content: '';
            position: fixed;
            inset: 0;
            background:
                radial-gradient(ellipse 80% 50% at 20% 0%, rgba(230, 47, 110, 0.06) 0%, transparent 50%),
                radial-gradient(ellipse 60% 40% at 80% 100%, rgba(233, 75, 82, 0.04) 0%, transparent 50%);
            pointer-events: none;
        }

        .app {
            position: relative;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Navigation */
        .nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 0 24px;
            border-bottom: 1px solid rgba(255,255,255,0.06);
            margin-bottom: 32px;
        }

        .nav-brand {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .nav-logo {
            width: 36px;
            height: 36px;
            background: linear-gradient(135deg, var(--dj-pink), var(--dj-orange));
            border-radius: 8px;
        }

        .nav-title {
            font-size: 18px;
            font-weight: 500;
            color: var(--text-white);
        }

        .nav-tabs {
            display: flex;
            gap: 8px;
        }

        .nav-tab {
            padding: 10px 20px;
            font-size: 13px;
            font-weight: 500;
            color: var(--text-muted);
            background: transparent;
            border: 1px solid transparent;
            border-radius: var(--radius-sm);
            cursor: pointer;
            text-decoration: none;
            transition: all 0.2s ease;
        }

        .nav-tab:hover {
            color: var(--text-secondary);
            border-color: rgba(255,255,255,0.1);
        }

        .nav-tab.active {
            background: var(--bg-surface);
            color: var(--text-white);
            border-color: rgba(255,255,255,0.1);
        }

        .nav-right {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .store-selector {
            background: var(--bg-surface);
            border: 1px solid rgba(255,255,255,0.08);
            border-radius: var(--radius-sm);
            padding: 10px 14px;
            color: var(--text-primary);
            font-family: inherit;
            font-size: 13px;
            cursor: pointer;
        }

        .live-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 11px;
            color: var(--text-muted);
        }

        .live-dot {
            width: 6px;
            height: 6px;
            background: var(--chart-teal);
            border-radius: 50%;
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.4; }
        }

        /* Hero Stats */
        .hero {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
            margin-bottom: 32px;
        }

        .hero-card {
            background: var(--bg-surface);
            border-radius: var(--radius-lg);
            padding: 28px;
            border: 1px solid rgba(255,255,255,0.04);
        }

        .hero-card.primary {
            background: linear-gradient(135deg, rgba(230, 47, 110, 0.12), rgba(233, 75, 82, 0.08));
            border-color: rgba(230, 47, 110, 0.2);
        }

        .hero-label {
            font-size: 12px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-muted);
            margin-bottom: 8px;
        }

        .hero-value {
            font-size: 56px;
            font-weight: 600;
            color: var(--text-white);
            line-height: 1;
            margin-bottom: 12px;
        }

        .hero-subtitle {
            font-size: 13px;
            color: var(--text-secondary);
        }

        .hero-comparison {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-size: 13px;
            font-weight: 500;
            padding: 4px 10px;
            border-radius: 20px;
            background: rgba(255, 255, 255, 0.06);
            color: var(--text-secondary);
            margin-top: 12px;
        }

        /* Sections */
        .section {
            margin-bottom: 32px;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .section-title {
            font-size: 16px;
            font-weight: 500;
            color: var(--text-white);
        }

        .section-tabs {
            display: flex;
            gap: 4px;
            background: var(--bg-surface);
            border-radius: var(--radius-sm);
            padding: 4px;
        }

        .section-tab {
            padding: 6px 14px;
            font-size: 12px;
            font-weight: 500;
            color: var(--text-muted);
            background: transparent;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .section-tab.active {
            background: var(--bg-elevated);
            color: var(--text-white);
        }

        .chart-container {
            background: var(--bg-surface);
            border-radius: var(--radius-lg);
            padding: 24px;
            border: 1px solid rgba(255,255,255,0.04);
        }

        /* Hourly Chart */
        .hourly-chart {
            display: flex;
            align-items: flex-end;
            gap: 4px;
            height: 180px;
            padding-top: 20px;
        }

        .chart-bar-wrapper {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            height: 100%;
        }

        .chart-bar {
            width: 100%;
            max-width: 32px;
            background: linear-gradient(180deg, var(--dj-pink), var(--dj-orange));
            border-radius: 4px 4px 0 0;
            min-height: 4px;
            transition: height 0.3s ease;
            position: relative;
            cursor: pointer;
        }

        .chart-bar:hover { opacity: 0.85; }

        .chart-bar::after {
            content: attr(data-value);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            padding: 4px 8px;
            background: var(--bg-elevated);
            border-radius: 4px;
            font-size: 11px;
            font-weight: 500;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s ease;
        }

        .chart-bar:hover::after { opacity: 1; }

        .chart-label {
            font-size: 10px;
            color: var(--text-muted);
            margin-top: 8px;
        }

        .chart-empty {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 180px;
            color: var(--text-muted);
        }

        /* Device Type Grid (BLE) */
        .device-type-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
        }

        .device-type-card {
            background: var(--bg-surface);
            border-radius: var(--radius-md);
            padding: 20px;
            text-align: center;
            border: 1px solid rgba(255,255,255,0.04);
        }

        .device-type-icon {
            width: 48px;
            height: 48px;
            margin: 0 auto 12px;
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
        }

        .device-type-card[data-type="apple"] .device-type-icon {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23A3AAAE'%3E%3Cpath d='M18.71 19.5c-.83 1.24-1.71 2.45-3.05 2.47-1.34.03-1.77-.79-3.29-.79-1.53 0-2 .77-3.27.82-1.31.05-2.3-1.32-3.14-2.53C4.25 17 2.94 12.45 4.7 9.39c.87-1.52 2.43-2.48 4.12-2.51 1.28-.02 2.5.87 3.29.87.78 0 2.26-1.07 3.81-.91.65.03 2.47.26 3.64 1.98-.09.06-2.17 1.28-2.15 3.81.03 3.02 2.65 4.03 2.68 4.04-.03.07-.42 1.44-1.38 2.83M13 3.5c.73-.83 1.94-1.46 2.94-1.5.13 1.17-.34 2.35-1.04 3.19-.69.85-1.83 1.51-2.95 1.42-.15-1.15.41-2.35 1.05-3.11z'/%3E%3C/svg%3E");
        }

        .device-type-card[data-type="android"] .device-type-icon {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%233DDC84'%3E%3Cpath d='M17.6 11.4c0-.8.7-1.4 1.4-1.4s1.4.6 1.4 1.4v4.3c0 .8-.6 1.4-1.4 1.4-.8 0-1.4-.6-1.4-1.4v-4.3zm-12.6 0c0-.8.6-1.4 1.4-1.4.8 0 1.4.6 1.4 1.4v4.3c0 .8-.6 1.4-1.4 1.4-.8 0-1.4-.6-1.4-1.4v-4.3zm1-1.4v7c0 .8.6 1.4 1.4 1.4h.6v3c0 .8.6 1.4 1.4 1.4.8 0 1.4-.6 1.4-1.4v-3h2.4v3c0 .8.6 1.4 1.4 1.4.8 0 1.4-.6 1.4-1.4v-3h.6c.8 0 1.4-.6 1.4-1.4v-7H6zm10-5l1.2-2.1c.1-.1 0-.3-.1-.3-.1-.1-.3 0-.3.1l-1.2 2.1c-1-.5-2.2-.7-3.4-.7s-2.4.2-3.4.7L7.6 2.6c-.1-.1-.2-.2-.3-.1-.1.1-.2.2-.1.3L8.4 5c-2 1-3.4 3-3.4 5.4h14c0-2.4-1.4-4.4-3.4-5.4zm-7.3 3c-.4 0-.7-.3-.7-.7s.3-.7.7-.7.7.3.7.7-.3.7-.7.7zm6.6 0c-.4 0-.7-.3-.7-.7s.3-.7.7-.7.7.3.7.7-.3.7-.7.7z'/%3E%3C/svg%3E");
        }

        .device-type-value {
            font-size: 28px;
            font-weight: 600;
            color: var(--text-white);
            margin-bottom: 4px;
        }

        .device-type-label {
            font-size: 12px;
            font-weight: 500;
            color: var(--text-muted);
            margin-bottom: 2px;
        }

        .device-type-desc {
            font-size: 11px;
            color: var(--text-secondary);
        }

        .device-type-card[data-type="apple"] .device-type-value { color: #A3AAAE; }
        .device-type-card[data-type="android"] .device-type-value { color: #3DDC84; }
        .device-type-card[data-type="other"] .device-type-value { color: var(--chart-purple); }

        /* Proximity Breakdown */
        .proximity-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
        }

        .proximity-card {
            background: var(--bg-surface);
            border-radius: var(--radius-md);
            padding: 20px;
            text-align: center;
            border: 1px solid rgba(255,255,255,0.04);
        }

        .proximity-icon {
            font-size: 28px;
            margin-bottom: 12px;
        }

        .proximity-value {
            font-size: 28px;
            font-weight: 600;
            color: var(--text-white);
            margin-bottom: 4px;
        }

        .proximity-label {
            font-size: 12px;
            font-weight: 500;
            color: var(--text-muted);
            margin-bottom: 2px;
        }

        .proximity-desc {
            font-size: 11px;
            color: var(--text-secondary);
        }

        .proximity-card[data-zone="counter"] .proximity-value { color: var(--chart-teal); }
        .proximity-card[data-zone="instore"] .proximity-value { color: var(--chart-green); }
        .proximity-card[data-zone="window"] .proximity-value { color: var(--chart-yellow); }
        .proximity-card[data-zone="outside"] .proximity-value { color: var(--chart-purple); }

        /* Engagement Grid */
        .engagement-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
        }

        .engagement-card {
            background: var(--bg-surface);
            border-radius: var(--radius-md);
            padding: 20px;
            text-align: center;
            border: 1px solid rgba(255,255,255,0.04);
        }

        .engagement-icon { font-size: 28px; margin-bottom: 12px; }
        .engagement-value {
            font-size: 28px;
            font-weight: 600;
            color: var(--text-white);
            margin-bottom: 4px;
        }
        .engagement-label {
            font-size: 12px;
            font-weight: 500;
            color: var(--text-muted);
            margin-bottom: 2px;
        }
        .engagement-desc {
            font-size: 11px;
            color: var(--text-secondary);
        }

        .engagement-card[data-type="passerby"] .engagement-value { color: var(--chart-purple); }
        .engagement-card[data-type="browser"] .engagement-value { color: var(--chart-teal); }
        .engagement-card[data-type="shopper"] .engagement-value { color: var(--chart-green); }
        .engagement-card[data-type="loyal"] .engagement-value { color: var(--chart-yellow); }

        /* Footer */
        .footer {
            text-align: center;
            padding: 32px 0;
            font-size: 11px;
            color: var(--text-muted);
        }

        /* Loading */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 48px;
            color: var(--text-muted);
        }

        .spinner {
            width: 24px;
            height: 24px;
            border: 2px solid var(--bg-elevated);
            border-top-color: var(--dj-pink);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-right: 12px;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        /* Responsive */
        @media (max-width: 900px) {
            .hero { grid-template-columns: 1fr; }
            .device-type-grid { grid-template-columns: repeat(3, 1fr); }
            .proximity-grid, .engagement-grid { grid-template-columns: repeat(2, 1fr); }
            .nav { flex-wrap: wrap; gap: 16px; }
            .nav-tabs { order: 3; width: 100%; justify-content: center; }
        }

        @media (max-width: 600px) {
            .app { padding: 16px; }
            .hero-value { font-size: 42px; }
            .nav-right { display: none; }
        }
    </style>
</head>
<body>
    <div class="app">
        <nav class="nav">
            <div class="nav-brand">
                <div class="nav-logo"></div>
                <span class="nav-title">DataJam</span>
            </div>
            <div class="nav-tabs">
                <a href="index.html" class="nav-tab active">My Store Insights</a>
                <a href="fleet.html" class="nav-tab">Out of Home</a>
            </div>
            <div class="nav-right">
                <select class="store-selector" id="storeSelector">
                    <option value="all">All Locations</option>
                </select>
                <div class="live-indicator">
                    <span class="live-dot"></span>
                    <span id="lastUpdated">Live</span>
                </div>
            </div>
        </nav>

        <!-- Hero Stats -->
        <section class="hero">
            <div class="hero-card primary">
                <div class="hero-label">Visitors Today</div>
                <div class="hero-value" id="heroVisitors">‚Äî</div>
                <div class="hero-subtitle">Unique people detected near your store</div>
                <div class="hero-comparison" id="heroComparison">‚Äî</div>
            </div>
            <div class="hero-card">
                <div class="hero-label">Busiest Hour</div>
                <div class="hero-value" id="heroPeakHour">‚Äî</div>
                <div class="hero-subtitle" id="heroPeakCount">‚Äî</div>
            </div>
        </section>

        <!-- Hourly Traffic -->
        <section class="section">
            <div class="section-header">
                <h2 class="section-title">Foot Traffic</h2>
                <div class="section-tabs">
                    <button class="section-tab active" data-range="today">Today</button>
                    <button class="section-tab" data-range="yesterday">Yesterday</button>
                    <button class="section-tab" data-range="week">This Week</button>
                </div>
            </div>
            <div class="chart-container">
                <div class="hourly-chart" id="hourlyChart">
                    <div class="loading"><div class="spinner"></div> Loading...</div>
                </div>
            </div>
        </section>

        <!-- Device Type Breakdown (BLE-based) -->
        <section class="section">
            <div class="section-header">
                <h2 class="section-title">Who's Visiting?</h2>
            </div>
            <div class="device-type-grid">
                <div class="device-type-card" data-type="apple">
                    <div class="device-type-icon"></div>
                    <div class="device-type-value" id="dtApple">‚Äî</div>
                    <div class="device-type-label">Apple</div>
                    <div class="device-type-desc">iPhone, iPad, Watch</div>
                </div>
                <div class="device-type-card" data-type="android">
                    <div class="device-type-icon"></div>
                    <div class="device-type-value" id="dtAndroid">‚Äî</div>
                    <div class="device-type-label">Android</div>
                    <div class="device-type-desc">Samsung, Pixel, etc.</div>
                </div>
                <div class="device-type-card" data-type="other">
                    <div class="device-type-icon">üì±</div>
                    <div class="device-type-value" id="dtOther">‚Äî</div>
                    <div class="device-type-label">Other</div>
                    <div class="device-type-desc">Wearables, IoT</div>
                </div>
            </div>
        </section>

        <!-- Proximity Breakdown -->
        <section class="section">
            <div class="section-header">
                <h2 class="section-title">Where Are They?</h2>
            </div>
            <div class="proximity-grid">
                <div class="proximity-card" data-zone="counter">
                    <div class="proximity-icon">üõí</div>
                    <div class="proximity-value" id="proxCounter">‚Äî</div>
                    <div class="proximity-label">At Counter</div>
                    <div class="proximity-desc">Within 2 meters</div>
                </div>
                <div class="proximity-card" data-zone="instore">
                    <div class="proximity-icon">üè™</div>
                    <div class="proximity-value" id="proxInStore">‚Äî</div>
                    <div class="proximity-label">In Store</div>
                    <div class="proximity-desc">2-5 meters</div>
                </div>
                <div class="proximity-card" data-zone="window">
                    <div class="proximity-icon">üëÄ</div>
                    <div class="proximity-value" id="proxWindow">‚Äî</div>
                    <div class="proximity-label">Window Shopping</div>
                    <div class="proximity-desc">5-15 meters</div>
                </div>
                <div class="proximity-card" data-zone="outside">
                    <div class="proximity-icon">üö∂</div>
                    <div class="proximity-value" id="proxOutside">‚Äî</div>
                    <div class="proximity-label">Walking Past</div>
                    <div class="proximity-desc">15+ meters</div>
                </div>
            </div>
        </section>

        <!-- Time Spent -->
        <section class="section">
            <div class="section-header">
                <h2 class="section-title">How Long Do They Stay?</h2>
            </div>
            <div class="engagement-grid">
                <div class="engagement-card" data-type="passerby">
                    <div class="engagement-icon">‚ö°</div>
                    <div class="engagement-value" id="engPasserby">‚Äî</div>
                    <div class="engagement-label">Quick Glance</div>
                    <div class="engagement-desc">Under 1 minute</div>
                </div>
                <div class="engagement-card" data-type="browser">
                    <div class="engagement-icon">üîç</div>
                    <div class="engagement-value" id="engBrowser">‚Äî</div>
                    <div class="engagement-label">Browsing</div>
                    <div class="engagement-desc">1-5 minutes</div>
                </div>
                <div class="engagement-card" data-type="shopper">
                    <div class="engagement-icon">üõçÔ∏è</div>
                    <div class="engagement-value" id="engShopper">‚Äî</div>
                    <div class="engagement-label">Shopping</div>
                    <div class="engagement-desc">5-10 minutes</div>
                </div>
                <div class="engagement-card" data-type="loyal">
                    <div class="engagement-icon">‚≠ê</div>
                    <div class="engagement-value" id="engLoyal">‚Äî</div>
                    <div class="engagement-label">Loyal Customer</div>
                    <div class="engagement-desc">10+ minutes</div>
                </div>
            </div>
        </section>

        <footer class="footer">
            Powered by DataJam ‚Ä¢ Updates every 5 minutes
        </footer>
    </div>

    <script>
        const API_BASE = '/.netlify/functions/nbiot-api';
        let hourlyData = [];

        async function loadDashboard() {
            try {
                const [statsRes, hourlyRes] = await Promise.all([
                    fetch(`${API_BASE}/stats`),
                    fetch(`${API_BASE}/hourly?days=7`)
                ]);

                const stats = await statsRes.json();
                const hourlyResp = await hourlyRes.json();
                hourlyData = hourlyResp.hourly || [];

                updateHeroStats(stats);
                updateHourlyChart('today');
                updateDeviceTypes(stats);
                updateProximity(stats);
                updateEngagement(stats);
                updateStoreSelector(stats.devices || []);

            } catch (err) {
                console.error('Failed to load:', err);
            }
        }

        function updateStoreSelector(devices) {
            const sel = document.getElementById('storeSelector');
            sel.innerHTML = '<option value="all">All Locations</option>';
            devices.filter(d => d.device_id.startsWith('JBNB')).forEach(d => {
                sel.innerHTML += `<option value="${d.device_id}">${d.location_name || d.device_id}</option>`;
            });
        }

        function updateHeroStats(stats) {
            const today = stats.today || {};
            document.getElementById('heroVisitors').textContent = (today.total_unique || 0).toLocaleString();

            const comp = document.getElementById('heroComparison');
            comp.textContent = `${today.readings_count || 0} data points collected`;

            // Peak hour from hourly data
            const todayHours = hourlyData.filter(h => new Date(h.hour).toDateString() === new Date().toDateString());
            if (todayHours.length > 0) {
                const peak = todayHours.reduce((max, h) => h.impressions > max.impressions ? h : max, todayHours[0]);
                const hr = new Date(peak.hour).getHours();
                document.getElementById('heroPeakHour').textContent = hr === 0 ? '12 AM' : hr < 12 ? `${hr} AM` : hr === 12 ? '12 PM' : `${hr-12} PM`;
                document.getElementById('heroPeakCount').textContent = `${peak.impressions.toLocaleString()} visitors`;
            }
        }

        function updateHourlyChart(range) {
            const chart = document.getElementById('hourlyChart');
            const now = new Date();
            let data = [];

            if (range === 'today') {
                data = hourlyData.filter(h => new Date(h.hour).toDateString() === now.toDateString());
            } else if (range === 'yesterday') {
                const yest = new Date(now); yest.setDate(yest.getDate() - 1);
                data = hourlyData.filter(h => new Date(h.hour).toDateString() === yest.toDateString());
            } else {
                data = hourlyData;
            }

            if (data.length === 0) {
                chart.innerHTML = '<div class="chart-empty">No data for this period</div>';
                return;
            }

            if (range === 'week') {
                // Aggregate by day
                const daily = {};
                data.forEach(h => {
                    const d = new Date(h.hour).toLocaleDateString('en-US', {weekday: 'short'});
                    daily[d] = (daily[d] || 0) + h.impressions;
                });
                const max = Math.max(...Object.values(daily), 1);
                chart.innerHTML = Object.entries(daily).map(([day, val]) => `
                    <div class="chart-bar-wrapper">
                        <div class="chart-bar" style="height: ${Math.max(5, val/max*100)}%" data-value="${val.toLocaleString()} visitors"></div>
                        <div class="chart-label">${day}</div>
                    </div>
                `).join('');
            } else {
                const hours = {};
                for (let i = 0; i < 24; i++) hours[i] = 0;
                data.forEach(h => { hours[new Date(h.hour).getHours()] = h.impressions; });
                const max = Math.max(...Object.values(hours), 1);
                chart.innerHTML = Object.entries(hours).map(([hr, val]) => {
                    const h = parseInt(hr);
                    const label = h === 0 ? '12a' : h < 12 ? `${h}a` : h === 12 ? '12p' : `${h-12}p`;
                    return `
                        <div class="chart-bar-wrapper">
                            <div class="chart-bar" style="height: ${Math.max(2, val/max*100)}%" data-value="${val} at ${label}"></div>
                            <div class="chart-label">${h % 3 === 0 ? label : ''}</div>
                        </div>
                    `;
                }).join('');
            }
        }

        function updateDeviceTypes(stats) {
            const t = stats.today || {};
            // BLE-based device type counts (accurate OS detection via manufacturer IDs)
            document.getElementById('dtApple').textContent = (t.ble_apple || 0).toLocaleString();
            document.getElementById('dtAndroid').textContent = (t.ble_android || 0).toLocaleString();
            document.getElementById('dtOther').textContent = (t.ble_other || 0).toLocaleString();
        }

        function updateProximity(stats) {
            const t = stats.today || {};
            document.getElementById('proxCounter').textContent = (t.rssi_immediate || 0).toLocaleString();
            document.getElementById('proxInStore').textContent = (t.rssi_near || 0).toLocaleString();
            document.getElementById('proxWindow').textContent = (t.rssi_far || 0).toLocaleString();
            document.getElementById('proxOutside').textContent = (t.rssi_remote || 0).toLocaleString();
        }

        function updateEngagement(stats) {
            const t = stats.today || {};
            document.getElementById('engPasserby').textContent = (t.dwell_0_1 || 0).toLocaleString();
            document.getElementById('engBrowser').textContent = (t.dwell_1_5 || 0).toLocaleString();
            document.getElementById('engShopper').textContent = (t.dwell_5_10 || 0).toLocaleString();
            document.getElementById('engLoyal').textContent = (t.dwell_10plus || 0).toLocaleString();
        }

        // Tab switching
        document.querySelectorAll('.section-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.section-tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                updateHourlyChart(tab.dataset.range);
            });
        });

        loadDashboard();
        setInterval(loadDashboard, 120000);
    </script>
</body>
</html>
