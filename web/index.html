<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NB-IoT Monitor | DataJam</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500&family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        :root {
            --bg-deep: #0a0a0a;
            --bg-surface: #141414;
            --bg-elevated: #1e1e1e;
            --text-primary: #e0e0e0;
            --text-secondary: #888;
            --text-muted: #555;
            --accent: #15E0BC;
            --accent-dim: rgba(21, 224, 188, 0.15);
            --border: rgba(255,255,255,0.08);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: 'Poppins', sans-serif;
            background: var(--bg-deep);
            color: var(--text-primary);
            min-height: 100vh;
            font-size: 14px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 16px;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0 20px;
            border-bottom: 1px solid var(--border);
            margin-bottom: 20px;
        }

        .logo {
            font-size: 16px;
            font-weight: 600;
            color: var(--accent);
        }

        .status {
            font-family: 'JetBrains Mono', monospace;
            font-size: 12px;
            color: var(--text-secondary);
        }

        .status .online { color: var(--accent); }

        /* Layout */
        .grid {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 20px;
        }

        @media (max-width: 900px) {
            .grid { grid-template-columns: 1fr; }
        }

        /* Sidebar */
        .sidebar {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .card {
            background: var(--bg-surface);
            border: 1px solid var(--border);
            border-radius: 8px;
            overflow: hidden;
        }

        .card-header {
            padding: 12px 16px;
            border-bottom: 1px solid var(--border);
            font-size: 12px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-secondary);
        }

        /* Map */
        #map {
            height: 200px;
            background: var(--bg-elevated);
        }

        .leaflet-container { background: var(--bg-deep); }

        /* Device List */
        .device {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            border-bottom: 1px solid var(--border);
            cursor: pointer;
            transition: background 0.15s;
        }

        .device:last-child { border-bottom: none; }
        .device:hover { background: var(--bg-elevated); }
        .device.selected { background: var(--accent-dim); }

        .device-checkbox {
            width: 16px;
            height: 16px;
            border: 2px solid var(--text-muted);
            border-radius: 3px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            transition: all 0.15s;
        }

        .device.selected .device-checkbox {
            background: var(--accent);
            border-color: var(--accent);
        }

        .device.selected .device-checkbox::after {
            content: 'âœ“';
            color: var(--bg-deep);
            font-size: 11px;
            font-weight: bold;
        }

        .device-info { flex: 1; }

        .device-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 4px;
        }

        .device-id {
            font-family: 'JetBrains Mono', monospace;
            font-size: 13px;
            font-weight: 500;
        }

        .device-status {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--text-muted);
        }

        .device-status.online { background: var(--accent); box-shadow: 0 0 6px var(--accent); }
        .device-status.warning { background: #EDBA06; }
        .device-status.offline { background: #E94B52; }

        .device-meta {
            font-size: 11px;
            color: var(--text-muted);
        }

        .device-actions {
            padding: 8px 16px;
            border-bottom: 1px solid var(--border);
            display: flex;
            gap: 8px;
        }

        .device-actions button {
            font-size: 11px;
            padding: 4px 8px;
        }

        /* Main Content */
        .main {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        /* Controls */
        .controls {
            display: flex;
            gap: 12px;
            align-items: center;
            flex-wrap: wrap;
        }

        select, button {
            font-family: inherit;
            font-size: 13px;
            padding: 8px 12px;
            background: var(--bg-surface);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-primary);
            cursor: pointer;
        }

        select:hover, button:hover {
            border-color: var(--accent);
        }

        button.active {
            background: var(--accent-dim);
            border-color: var(--accent);
            color: var(--accent);
        }

        .spacer { flex: 1; }

        /* Stats Row */
        .stats-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 12px;
        }

        .stat {
            background: var(--bg-surface);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 12px;
            text-align: center;
        }

        .stat-value {
            font-family: 'JetBrains Mono', monospace;
            font-size: 20px;
            font-weight: 500;
            color: var(--text-primary);
        }

        .stat-label {
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-muted);
            margin-top: 4px;
        }

        /* Data Table */
        .table-wrapper {
            background: var(--bg-surface);
            border: 1px solid var(--border);
            border-radius: 8px;
            overflow: hidden;
        }

        .table-scroll {
            overflow-x: auto;
            max-height: 500px;
            overflow-y: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-family: 'JetBrains Mono', monospace;
            font-size: 12px;
        }

        th, td {
            padding: 10px 12px;
            text-align: right;
            border-bottom: 1px solid var(--border);
            white-space: nowrap;
        }

        th {
            position: sticky;
            top: 0;
            background: var(--bg-elevated);
            font-weight: 500;
            color: var(--text-secondary);
            text-transform: uppercase;
            font-size: 10px;
            letter-spacing: 0.05em;
        }

        td:first-child, th:first-child {
            text-align: left;
            position: sticky;
            left: 0;
            background: var(--bg-surface);
            z-index: 1;
        }

        th:first-child {
            background: var(--bg-elevated);
            z-index: 2;
        }

        tr:hover td {
            background: var(--bg-elevated);
        }

        tr:hover td:first-child {
            background: var(--bg-elevated);
        }

        .cell-highlight {
            color: var(--accent);
        }

        /* Column group headers */
        .header-groups th {
            text-align: center;
            font-size: 9px;
            padding: 6px 8px;
            border-bottom: 2px solid var(--border);
        }

        .group-wifi { background: rgba(21, 224, 188, 0.1); color: var(--accent); }
        .group-ble { background: rgba(147, 51, 234, 0.1); color: #a855f7; }
        .group-dwell { background: rgba(251, 191, 36, 0.1); color: #fbbf24; }
        .group-prox { background: rgba(59, 130, 246, 0.1); color: #3b82f6; }
        .group-signal { background: rgba(239, 68, 68, 0.1); color: #ef4444; }

        /* Loading */
        .loading {
            padding: 40px;
            text-align: center;
            color: var(--text-muted);
        }

        footer {
            text-align: center;
            padding: 20px;
            font-size: 11px;
            color: var(--text-muted);
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="logo">NB-IoT Monitor</div>
            <div class="status">
                <span class="online" id="onlineCount">-</span> online &middot;
                Last update: <span id="lastUpdate">-</span>
            </div>
        </header>

        <div class="grid">
            <div class="sidebar">
                <div class="card">
                    <div class="card-header">Map</div>
                    <div id="map"></div>
                </div>

                <div class="card">
                    <div class="card-header">Devices</div>
                    <div id="deviceList">
                        <div class="loading">Loading...</div>
                    </div>
                </div>
            </div>

            <div class="main">
                <div class="controls">
                    <span id="selectionInfo" style="color: var(--text-secondary); font-size: 13px;">All devices</span>
                    <select id="daysSelect">
                        <option value="1">Today</option>
                        <option value="3" selected>Last 3 Days</option>
                        <option value="7">Last 7 Days</option>
                        <option value="14">Last 14 Days</option>
                    </select>
                    <button id="refreshBtn">Refresh</button>
                    <div class="spacer"></div>
                    <button id="viewHourly" class="active">Hourly</button>
                    <button id="viewDaily">Daily</button>
                </div>

                <div class="stats-row" id="statsRow">
                    <div class="stat"><div class="stat-value" id="totalImpressions">-</div><div class="stat-label">WiFi Impressions</div></div>
                    <div class="stat"><div class="stat-value" id="totalUnique">-</div><div class="stat-label">WiFi Unique</div></div>
                    <div class="stat"><div class="stat-value" id="totalBleImpressions">-</div><div class="stat-label">BLE Impressions</div></div>
                    <div class="stat"><div class="stat-value" id="totalBleUnique">-</div><div class="stat-label">BLE Unique</div></div>
                    <div class="stat"><div class="stat-value" id="totalBleApple">-</div><div class="stat-label">BLE Apple</div></div>
                    <div class="stat"><div class="stat-value" id="totalBleOther">-</div><div class="stat-label">BLE Other</div></div>
                </div>

                <div class="table-wrapper">
                    <div class="table-scroll">
                        <table id="dataTable">
                            <thead>
                                <tr class="header-groups">
                                    <th colspan="2"></th>
                                    <th colspan="3" class="group-wifi">WiFi Probes</th>
                                    <th colspan="5" class="group-ble">BLE Devices</th>
                                    <th colspan="4" class="group-dwell">Dwell Time</th>
                                    <th colspan="4" class="group-prox">Proximity Zones</th>
                                    <th colspan="5" class="group-signal">Signal Strength</th>
                                </tr>
                                <tr>
                                    <th>Time</th>
                                    <th>Device</th>
                                    <th>Imp</th>
                                    <th>Unique</th>
                                    <th>Apple</th>
                                    <th>Imp</th>
                                    <th>Unique</th>
                                    <th>Apple</th>
                                    <th>Other</th>
                                    <th>RSSI</th>
                                    <th>&lt;1m</th>
                                    <th>1-5m</th>
                                    <th>5-10m</th>
                                    <th>10m+</th>
                                    <th>Imm</th>
                                    <th>Near</th>
                                    <th>Far</th>
                                    <th>Remote</th>
                                    <th>Avg</th>
                                    <th>Min</th>
                                    <th>Max</th>
                                    <th>Cell</th>
                                    <th>Signal</th>
                                </tr>
                            </thead>
                            <tbody id="tableBody">
                                <tr><td colspan="23" class="loading">Loading data...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <footer>
            NB-IoT JamBox Monitor &middot; Data updates every 5 minutes
        </footer>
    </div>

    <script>
        const API_BASE = '/.netlify/functions/nbiot-api';
        let map, markers = [];
        let selectedDevices = new Set();  // Multi-select: empty = all devices
        let currentDays = 3;
        let viewMode = 'hourly';
        let allReadings = [];
        let devices = [];

        // Initialize map
        function initMap() {
            map = L.map('map', { zoomControl: false, attributionControl: false }).setView([34.0195, -118.4912], 10);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { maxZoom: 19 }).addTo(map);
        }

        function updateMap() {
            markers.forEach(m => map.removeLayer(m));
            markers = [];
            const bounds = [];

            devices.filter(d => d.latitude && d.longitude).forEach(d => {
                const color = d.connection_status === 'online' ? '#15E0BC' : d.connection_status === 'warning' ? '#EDBA06' : '#E94B52';
                const marker = L.circleMarker([d.latitude, d.longitude], {
                    radius: 8, fillColor: color, fillOpacity: 1, stroke: true, color: '#fff', weight: 2
                }).addTo(map);
                marker.bindPopup(`<b>${d.device_id}</b><br>${d.location_name || 'No location'}<br>Signal: ${d.last_signal_dbm || '-'} dBm`);
                markers.push(marker);
                bounds.push([d.latitude, d.longitude]);
            });

            if (bounds.length > 0) map.fitBounds(bounds, { padding: [20, 20], maxZoom: 14 });
        }

        function updateDeviceList() {
            const container = document.getElementById('deviceList');

            // Selection actions
            const actionsHtml = `
                <div class="device-actions">
                    <button onclick="selectAllDevices()">Select All</button>
                    <button onclick="clearSelection()">Clear</button>
                </div>
            `;

            const devicesHtml = devices.map(d => {
                const isSelected = selectedDevices.size === 0 || selectedDevices.has(d.device_id);
                const displayName = d.location_name || d.device_id;
                const fw = d.firmware_version ? `v${d.firmware_version}` : '-';
                return `
                <div class="device ${isSelected ? 'selected' : ''}" data-id="${d.device_id}">
                    <div class="device-checkbox"></div>
                    <div class="device-info">
                        <div class="device-header">
                            <span class="device-id">${displayName}</span>
                            <span class="device-status ${d.connection_status}"></span>
                        </div>
                        <div class="device-meta">${d.device_id} &middot; ${fw} &middot; ${d.last_seen_ago || 'Never'} &middot; ${d.last_signal_dbm || '-'} dBm</div>
                    </div>
                </div>
            `}).join('');

            container.innerHTML = actionsHtml + devicesHtml;

            container.querySelectorAll('.device').forEach(el => {
                el.addEventListener('click', () => {
                    const deviceId = el.dataset.id;
                    if (selectedDevices.has(deviceId)) {
                        selectedDevices.delete(deviceId);
                    } else {
                        selectedDevices.add(deviceId);
                    }
                    updateDeviceList();
                    updateSelectionInfo();
                    renderData();
                });
            });
        }

        function selectAllDevices() {
            devices.forEach(d => selectedDevices.add(d.device_id));
            updateDeviceList();
            updateSelectionInfo();
            renderData();
        }

        function clearSelection() {
            selectedDevices.clear();
            updateDeviceList();
            updateSelectionInfo();
            renderData();
        }

        function updateSelectionInfo() {
            const info = document.getElementById('selectionInfo');
            if (selectedDevices.size === 0) {
                info.textContent = 'All devices';
            } else if (selectedDevices.size === 1) {
                const deviceId = [...selectedDevices][0];
                const device = devices.find(d => d.device_id === deviceId);
                info.textContent = device?.location_name || deviceId;
            } else {
                info.textContent = `${selectedDevices.size} devices selected`;
            }
        }

        async function loadDevices() {
            try {
                const res = await fetch(`${API_BASE}/devices`);
                const data = await res.json();
                devices = data.devices || [];

                document.getElementById('onlineCount').textContent = data.stats?.online || 0;

                updateMap();
                updateDeviceList();
                updateSelectionInfo();
            } catch (err) {
                console.error('Failed to load devices:', err);
            }
        }

        async function loadReadings() {
            try {
                const res = await fetch(`${API_BASE}/readings?days=${currentDays}&limit=2000`);
                const data = await res.json();
                allReadings = data.readings || [];
                document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();
                renderData();
            } catch (err) {
                console.error('Failed to load readings:', err);
            }
        }

        function renderData() {
            let filtered = allReadings;
            // Filter by selected devices (empty set means show all)
            if (selectedDevices.size > 0) {
                filtered = allReadings.filter(r => selectedDevices.has(r.device_id));
            }

            // Calculate totals
            const totals = {
                impressions: 0, unique: 0,
                ble_impressions: 0, ble_unique: 0, ble_apple: 0, ble_other: 0
            };

            filtered.forEach(r => {
                totals.impressions += r.impressions || 0;
                totals.unique += r.unique_count || 0;
                totals.ble_impressions += r.ble_impressions || 0;
                totals.ble_unique += r.ble_unique || 0;
                totals.ble_apple += r.ble_apple || 0;
                totals.ble_other += (r.ble_android || 0) + (r.ble_other || 0);
            });

            document.getElementById('totalImpressions').textContent = totals.impressions.toLocaleString();
            document.getElementById('totalUnique').textContent = totals.unique.toLocaleString();
            document.getElementById('totalBleImpressions').textContent = totals.ble_impressions.toLocaleString();
            document.getElementById('totalBleUnique').textContent = totals.ble_unique.toLocaleString();
            document.getElementById('totalBleApple').textContent = totals.ble_apple.toLocaleString();
            document.getElementById('totalBleOther').textContent = totals.ble_other.toLocaleString();

            // Group data
            const grouped = {};
            filtered.forEach(r => {
                const date = new Date(r.timestamp);
                let key;
                if (viewMode === 'hourly') {
                    key = `${date.toLocaleDateString()} ${String(date.getHours()).padStart(2, '0')}:00`;
                } else {
                    key = date.toLocaleDateString();
                }
                // Show device column when multiple devices selected (or none = all)
                const showDeviceColumn = selectedDevices.size !== 1;
                const groupKey = showDeviceColumn ? `${key}|${r.device_id}` : key;

                if (!grouped[groupKey]) {
                    grouped[groupKey] = {
                        time: key,
                        device: r.device_id,
                        // WiFi counts
                        impressions: 0, unique: 0, wifi_apple: 0,
                        // BLE counts
                        ble_impressions: 0, ble_unique: 0, ble_apple: 0, ble_other: 0,
                        ble_rssi: [],
                        // Dwell time
                        dwell_0_1: 0, dwell_1_5: 0, dwell_5_10: 0, dwell_10plus: 0,
                        // Proximity zones
                        rssi_immediate: 0, rssi_near: 0, rssi_far: 0, rssi_remote: 0,
                        // Signal strength
                        probe_rssi_avg: [], probe_rssi_min: [], probe_rssi_max: [],
                        cell_rssi: [], signal_dbm: []
                    };
                }

                const g = grouped[groupKey];
                // WiFi
                g.impressions += r.impressions || 0;
                g.unique += r.unique_count || 0;
                g.wifi_apple += r.apple_count || 0;
                // BLE
                g.ble_impressions += r.ble_impressions || 0;
                g.ble_unique += r.ble_unique || 0;
                g.ble_apple += r.ble_apple || 0;
                g.ble_other += (r.ble_android || 0) + (r.ble_other || 0);
                if (r.ble_rssi_avg) g.ble_rssi.push(r.ble_rssi_avg);
                // Dwell
                g.dwell_0_1 += r.dwell_0_1 || 0;
                g.dwell_1_5 += r.dwell_1_5 || 0;
                g.dwell_5_10 += r.dwell_5_10 || 0;
                g.dwell_10plus += r.dwell_10plus || 0;
                // Proximity
                g.rssi_immediate += r.rssi_immediate || 0;
                g.rssi_near += r.rssi_near || 0;
                g.rssi_far += r.rssi_far || 0;
                g.rssi_remote += r.rssi_remote || 0;
                // Signal
                if (r.probe_rssi_avg) g.probe_rssi_avg.push(r.probe_rssi_avg);
                if (r.probe_rssi_min) g.probe_rssi_min.push(r.probe_rssi_min);
                if (r.probe_rssi_max) g.probe_rssi_max.push(r.probe_rssi_max);
                if (r.cell_rssi) g.cell_rssi.push(r.cell_rssi);
                if (r.signal_dbm) g.signal_dbm.push(r.signal_dbm);
            });

            // Sort by time descending
            const rows = Object.values(grouped).sort((a, b) => {
                if (a.time !== b.time) return b.time.localeCompare(a.time);
                return a.device.localeCompare(b.device);
            });

            // Render table
            const tbody = document.getElementById('tableBody');
            if (rows.length === 0) {
                tbody.innerHTML = '<tr><td colspan="23" class="loading">No data for selected period</td></tr>';
                return;
            }

            // Helper to average arrays
            const avg = arr => arr.length ? Math.round(arr.reduce((a,b) => a+b, 0) / arr.length) : '-';
            const min = arr => arr.length ? Math.min(...arr) : '-';
            const max = arr => arr.length ? Math.max(...arr) : '-';

            tbody.innerHTML = rows.map(r => {
                return `<tr>
                    <td>${r.time}</td>
                    <td>${r.device}</td>
                    <!-- WiFi Probes -->
                    <td>${r.impressions}</td>
                    <td>${r.unique}</td>
                    <td>${r.wifi_apple}</td>
                    <!-- BLE Devices -->
                    <td>${r.ble_impressions}</td>
                    <td>${r.ble_unique}</td>
                    <td class="cell-highlight">${r.ble_apple}</td>
                    <td>${r.ble_other}</td>
                    <td>${avg(r.ble_rssi)}</td>
                    <!-- Dwell Time -->
                    <td>${r.dwell_0_1}</td>
                    <td>${r.dwell_1_5}</td>
                    <td>${r.dwell_5_10}</td>
                    <td>${r.dwell_10plus}</td>
                    <!-- Proximity Zones -->
                    <td>${r.rssi_immediate}</td>
                    <td>${r.rssi_near}</td>
                    <td>${r.rssi_far}</td>
                    <td>${r.rssi_remote}</td>
                    <!-- Signal Strength -->
                    <td>${avg(r.probe_rssi_avg)}</td>
                    <td>${min(r.probe_rssi_min)}</td>
                    <td>${max(r.probe_rssi_max)}</td>
                    <td>${avg(r.cell_rssi)}</td>
                    <td>${avg(r.signal_dbm)}</td>
                </tr>`;
            }).join('');
        }

        // Event listeners
        document.getElementById('daysSelect').addEventListener('change', (e) => {
            currentDays = parseInt(e.target.value);
            loadReadings();
        });

        document.getElementById('refreshBtn').addEventListener('click', () => {
            loadDevices();
            loadReadings();
        });

        document.getElementById('viewHourly').addEventListener('click', () => {
            viewMode = 'hourly';
            document.getElementById('viewHourly').classList.add('active');
            document.getElementById('viewDaily').classList.remove('active');
            renderData();
        });

        document.getElementById('viewDaily').addEventListener('click', () => {
            viewMode = 'daily';
            document.getElementById('viewDaily').classList.add('active');
            document.getElementById('viewHourly').classList.remove('active');
            renderData();
        });

        // Initialize
        initMap();
        loadDevices();
        loadReadings();

        // Auto-refresh every 2 minutes
        setInterval(() => {
            loadDevices();
            loadReadings();
        }, 120000);
    </script>
</body>
</html>
