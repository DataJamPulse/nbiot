<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Locations | DataJam</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        :root {
            --dj-black: #0A0C11;
            --dj-white: #FEFAF9;
            --dj-pink: #E62F6E;
            --dj-orange: #E94B52;

            --chart-purple: #5E2BFF;
            --chart-teal: #15E0BC;
            --chart-green: #78C534;
            --chart-yellow: #EDBA06;

            --bg-deep: #050608;
            --bg-surface: #12141A;
            --bg-elevated: #1A1D24;

            --text-white: var(--dj-white);
            --text-primary: #E8E6E4;
            --text-secondary: #9A9896;
            --text-muted: #5A5856;

            --radius-sm: 8px;
            --radius-md: 16px;
            --radius-lg: 24px;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        html { font-size: 16px; }

        body {
            font-family: 'Poppins', sans-serif;
            font-weight: 300;
            background: var(--bg-deep);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.5;
        }

        body::before {
            content: '';
            position: fixed;
            inset: 0;
            background:
                radial-gradient(ellipse 80% 50% at 20% 0%, rgba(230, 47, 110, 0.06) 0%, transparent 50%),
                radial-gradient(ellipse 60% 40% at 80% 100%, rgba(233, 75, 82, 0.04) 0%, transparent 50%);
            pointer-events: none;
            z-index: -1;
        }

        .app {
            position: relative;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Navigation */
        .nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 0 24px;
            border-bottom: 1px solid rgba(255,255,255,0.06);
            margin-bottom: 32px;
        }

        .nav-brand {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .nav-logo {
            width: 36px;
            height: 36px;
            background: linear-gradient(135deg, var(--dj-pink), var(--dj-orange));
            border-radius: 8px;
        }

        .nav-title {
            font-size: 18px;
            font-weight: 500;
            color: var(--text-white);
        }

        .nav-tabs {
            display: flex;
            gap: 8px;
        }

        .nav-tab {
            padding: 10px 20px;
            font-size: 13px;
            font-weight: 500;
            color: var(--text-muted);
            background: transparent;
            border: 1px solid transparent;
            border-radius: var(--radius-sm);
            cursor: pointer;
            text-decoration: none;
            transition: all 0.2s ease;
        }

        .nav-tab:hover {
            color: var(--text-secondary);
            border-color: rgba(255,255,255,0.1);
        }

        .nav-tab.active {
            background: var(--bg-surface);
            color: var(--text-white);
            border-color: rgba(255,255,255,0.1);
        }

        /* Page Layout */
        .page-header {
            margin-bottom: 24px;
        }

        .page-title {
            font-size: 24px;
            font-weight: 600;
            color: var(--text-white);
            margin-bottom: 8px;
        }

        .page-subtitle {
            font-size: 14px;
            color: var(--text-secondary);
        }

        .grid-layout {
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 24px;
        }

        /* Map */
        .map-container {
            background: var(--bg-surface);
            border-radius: var(--radius-lg);
            overflow: hidden;
            border: 1px solid rgba(255,255,255,0.04);
            height: 500px;
        }

        #map {
            width: 100%;
            height: 100%;
        }

        .leaflet-container {
            background: var(--bg-deep);
        }

        /* Sidebar */
        .sidebar {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        /* Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }

        .stat-card {
            background: var(--bg-surface);
            border-radius: var(--radius-md);
            padding: 16px;
            border: 1px solid rgba(255,255,255,0.04);
        }

        .stat-value {
            font-size: 28px;
            font-weight: 600;
            color: var(--text-white);
            margin-bottom: 4px;
        }

        .stat-label {
            font-size: 11px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.04em;
            color: var(--text-muted);
        }

        .stat-card.online .stat-value { color: var(--chart-teal); }
        .stat-card.warning .stat-value { color: var(--chart-yellow); }
        .stat-card.offline .stat-value { color: var(--dj-orange); }

        /* Devices List */
        .devices-panel {
            background: var(--bg-surface);
            border-radius: var(--radius-lg);
            border: 1px solid rgba(255,255,255,0.04);
            overflow: hidden;
            flex: 1;
        }

        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            border-bottom: 1px solid rgba(255,255,255,0.04);
        }

        .panel-title {
            font-size: 14px;
            font-weight: 500;
            color: var(--text-white);
        }

        .devices-list {
            max-height: 320px;
            overflow-y: auto;
        }

        .device-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 14px 20px;
            border-bottom: 1px solid rgba(255,255,255,0.04);
            cursor: pointer;
            transition: background 0.2s ease;
        }

        .device-item:hover {
            background: var(--bg-elevated);
        }

        .device-item:last-child {
            border-bottom: none;
        }

        .device-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .device-status {
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }

        .device-status.online {
            background: var(--chart-teal);
            box-shadow: 0 0 8px var(--chart-teal);
        }

        .device-status.warning {
            background: var(--chart-yellow);
        }

        .device-status.offline {
            background: var(--dj-orange);
        }

        .device-name {
            font-size: 14px;
            font-weight: 500;
            color: var(--text-white);
        }

        .device-meta {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .device-stats {
            text-align: right;
        }

        .device-signal {
            font-size: 13px;
            color: var(--text-primary);
        }

        .device-seen {
            font-size: 11px;
            color: var(--text-muted);
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(5, 6, 8, 0.9);
            backdrop-filter: blur(8px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
        }

        .modal {
            background: var(--bg-surface);
            border-radius: var(--radius-lg);
            width: 100%;
            max-width: 560px;
            max-height: 85vh;
            overflow-y: auto;
            border: 1px solid rgba(255,255,255,0.06);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 24px;
            border-bottom: 1px solid rgba(255,255,255,0.04);
        }

        .modal-title {
            font-size: 18px;
            font-weight: 500;
            color: var(--text-white);
        }

        .modal-close {
            width: 32px;
            height: 32px;
            background: var(--bg-elevated);
            border: none;
            border-radius: var(--radius-sm);
            color: var(--text-muted);
            font-size: 18px;
            cursor: pointer;
        }

        .modal-close:hover { color: var(--text-white); }

        .modal-body { padding: 24px; }

        .modal-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-bottom: 24px;
        }

        .modal-stat {
            background: var(--bg-deep);
            border-radius: var(--radius-sm);
            padding: 16px;
            text-align: center;
        }

        .modal-stat-value {
            font-size: 20px;
            font-weight: 600;
            color: var(--text-white);
        }

        .modal-stat-label {
            font-size: 10px;
            color: var(--text-muted);
            text-transform: uppercase;
            margin-top: 4px;
        }

        .readings-list {
            max-height: 350px;
            overflow-y: auto;
        }

        .reading-row {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid rgba(255,255,255,0.04);
            font-size: 13px;
        }

        .reading-time { color: var(--text-secondary); }
        .reading-value { color: var(--text-white); font-weight: 500; }

        /* Data Quality Badges */
        .quality-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 500;
        }
        .quality-badge.live { background: rgba(21, 224, 188, 0.15); color: var(--chart-teal); }
        .quality-badge.cached { background: rgba(237, 186, 6, 0.15); color: var(--chart-yellow); }
        .quality-badge.overflow { background: rgba(233, 75, 82, 0.15); color: var(--dj-orange); }
        .quality-badge.retried { background: rgba(94, 43, 255, 0.15); color: var(--chart-purple); }

        /* Quality Status */
        .quality-status {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.03em;
        }
        .quality-status.ok { background: rgba(21, 224, 188, 0.15); color: var(--chart-teal); }
        .quality-status.catching-up { background: rgba(237, 186, 6, 0.15); color: var(--chart-yellow); }
        .quality-status.degraded { background: rgba(233, 75, 82, 0.15); color: var(--dj-orange); }

        .reading-quality {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
            margin-top: 4px;
        }

        /* Device Health Section */
        .health-section {
            margin-top: 32px;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .section-title {
            font-size: 18px;
            font-weight: 500;
            color: var(--text-white);
        }

        .health-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(340px, 1fr));
            gap: 16px;
        }

        .health-card {
            background: var(--bg-surface);
            border-radius: var(--radius-md);
            border: 1px solid rgba(255,255,255,0.04);
            padding: 20px;
            transition: border-color 0.2s ease;
        }

        .health-card:hover {
            border-color: rgba(255,255,255,0.1);
        }

        .health-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 16px;
        }

        .health-device-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .health-status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            flex-shrink: 0;
        }

        .health-status-dot.online {
            background: var(--chart-teal);
            box-shadow: 0 0 8px var(--chart-teal);
        }

        .health-status-dot.warning {
            background: var(--chart-yellow);
            box-shadow: 0 0 8px rgba(237, 186, 6, 0.4);
        }

        .health-status-dot.offline {
            background: var(--dj-orange);
            box-shadow: 0 0 8px rgba(233, 75, 82, 0.4);
        }

        .health-device-name {
            font-size: 15px;
            font-weight: 500;
            color: var(--text-white);
        }

        .health-device-id {
            font-size: 11px;
            color: var(--text-muted);
            font-family: monospace;
        }

        .health-badge {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.03em;
        }

        .health-badge.online {
            background: rgba(21, 224, 188, 0.15);
            color: var(--chart-teal);
        }

        .health-badge.warning {
            background: rgba(237, 186, 6, 0.15);
            color: var(--chart-yellow);
        }

        .health-badge.offline {
            background: rgba(233, 75, 82, 0.15);
            color: var(--dj-orange);
        }

        .health-metrics {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }

        .health-metric {
            background: var(--bg-deep);
            border-radius: var(--radius-sm);
            padding: 12px;
        }

        .health-metric-label {
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 0.04em;
            color: var(--text-muted);
            margin-bottom: 4px;
        }

        .health-metric-value {
            font-size: 14px;
            font-weight: 500;
            color: var(--text-white);
        }

        .health-metric-value.good { color: var(--chart-teal); }
        .health-metric-value.warn { color: var(--chart-yellow); }
        .health-metric-value.bad { color: var(--dj-orange); }

        .signal-bar {
            height: 4px;
            background: var(--bg-elevated);
            border-radius: 2px;
            margin-top: 6px;
            overflow: hidden;
        }

        .signal-bar-fill {
            height: 100%;
            border-radius: 2px;
            transition: width 0.3s ease;
        }

        .health-location {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid rgba(255,255,255,0.04);
            font-size: 12px;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .health-location svg {
            width: 14px;
            height: 14px;
            opacity: 0.6;
        }

        /* Command Buttons */
        .command-buttons {
            display: flex;
            gap: 8px;
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid rgba(255,255,255,0.06);
        }

        .cmd-btn {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            padding: 10px 12px;
            font-family: inherit;
            font-size: 12px;
            font-weight: 500;
            color: var(--text-primary);
            background: var(--bg-elevated);
            border: 1px solid rgba(255,255,255,0.08);
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .cmd-btn:hover {
            background: var(--bg-surface);
            border-color: rgba(255,255,255,0.15);
            color: var(--text-white);
        }

        .cmd-btn:active {
            transform: scale(0.98);
        }

        .cmd-btn.loading {
            opacity: 0.6;
            pointer-events: none;
        }

        .cmd-btn.success {
            background: rgba(21, 224, 188, 0.15);
            border-color: var(--chart-teal);
            color: var(--chart-teal);
        }

        .cmd-btn svg {
            width: 14px;
            height: 14px;
        }

        .cmd-btn.send svg { stroke: var(--chart-teal); }
        .cmd-btn.reboot svg { stroke: var(--chart-yellow); }
        .cmd-btn.locate svg { stroke: var(--chart-purple); }

        .cmd-btn:hover.send svg { stroke: var(--chart-teal); }
        .cmd-btn:hover.reboot svg { stroke: var(--chart-yellow); }
        .cmd-btn:hover.locate svg { stroke: var(--chart-purple); }

        /* Modal Tabs */
        .modal-tabs {
            display: flex;
            gap: 4px;
            padding: 0 24px;
            background: var(--bg-deep);
            border-bottom: 1px solid rgba(255,255,255,0.04);
        }

        .modal-tab {
            padding: 12px 20px;
            font-size: 13px;
            font-weight: 500;
            color: var(--text-muted);
            background: transparent;
            border: none;
            border-bottom: 2px solid transparent;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .modal-tab:hover {
            color: var(--text-secondary);
        }

        .modal-tab.active {
            color: var(--text-white);
            border-bottom-color: var(--dj-pink);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Settings Panel */
        .settings-section {
            margin-bottom: 24px;
        }

        .settings-section-title {
            font-size: 13px;
            font-weight: 500;
            color: var(--text-white);
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .settings-section-title svg {
            width: 16px;
            height: 16px;
            opacity: 0.6;
        }

        .setting-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid rgba(255,255,255,0.04);
        }

        .setting-row:last-child {
            border-bottom: none;
        }

        .setting-label {
            font-size: 13px;
            color: var(--text-primary);
        }

        .setting-sublabel {
            font-size: 11px;
            color: var(--text-muted);
            margin-top: 2px;
        }

        .setting-value {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .setting-value-display {
            font-size: 13px;
            font-weight: 500;
            color: var(--text-white);
            min-width: 60px;
            text-align: right;
        }

        /* Range Slider */
        .range-slider {
            -webkit-appearance: none;
            width: 120px;
            height: 4px;
            background: var(--bg-elevated);
            border-radius: 2px;
            outline: none;
        }

        .range-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 16px;
            height: 16px;
            background: var(--dj-pink);
            border-radius: 50%;
            cursor: pointer;
            transition: transform 0.2s ease;
        }

        .range-slider::-webkit-slider-thumb:hover {
            transform: scale(1.2);
        }

        .range-slider::-moz-range-thumb {
            width: 16px;
            height: 16px;
            background: var(--dj-pink);
            border: none;
            border-radius: 50%;
            cursor: pointer;
        }

        /* Select Dropdown */
        .settings-select {
            background: var(--bg-elevated);
            border: 1px solid rgba(255,255,255,0.08);
            border-radius: var(--radius-sm);
            padding: 8px 12px;
            font-family: inherit;
            font-size: 13px;
            color: var(--text-white);
            cursor: pointer;
            outline: none;
        }

        .settings-select:hover {
            border-color: rgba(255,255,255,0.15);
        }

        .settings-select:focus {
            border-color: var(--dj-pink);
        }

        /* Save Button */
        .save-btn {
            width: 100%;
            padding: 14px;
            margin-top: 24px;
            font-family: inherit;
            font-size: 14px;
            font-weight: 500;
            color: var(--text-white);
            background: linear-gradient(135deg, var(--dj-pink), var(--dj-orange));
            border: none;
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .save-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(230, 47, 110, 0.3);
        }

        .save-btn:active {
            transform: translateY(0);
        }

        .save-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .save-btn.success {
            background: var(--chart-teal);
        }

        .config-version {
            font-size: 11px;
            color: var(--text-muted);
            text-align: center;
            margin-top: 8px;
        }

        /* Footer */
        .footer {
            text-align: center;
            padding: 32px 0;
            font-size: 11px;
            color: var(--text-muted);
        }

        /* Loading */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 48px;
            color: var(--text-muted);
        }

        .spinner {
            width: 24px;
            height: 24px;
            border: 2px solid var(--bg-elevated);
            border-top-color: var(--dj-pink);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-right: 12px;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        /* Responsive */
        @media (max-width: 1000px) {
            .grid-layout {
                grid-template-columns: 1fr;
            }
            .map-container { height: 350px; }
            .sidebar { flex-direction: row; flex-wrap: wrap; }
            .stats-grid { flex: 1; min-width: 200px; }
            .devices-panel { flex: 2; min-width: 300px; }
        }

        @media (max-width: 600px) {
            .app { padding: 16px; }
            .nav { flex-wrap: wrap; gap: 16px; }
            .nav-tabs { order: 3; width: 100%; justify-content: center; }
        }
    </style>
</head>
<body>
    <div class="app">
        <nav class="nav">
            <div class="nav-brand">
                <div class="nav-logo"></div>
                <span class="nav-title">DataJam</span>
            </div>
            <div class="nav-tabs">
                <a href="index.html" class="nav-tab">My Store Insights</a>
                <a href="locations.html" class="nav-tab active">My Locations</a>
            </div>
        </nav>

        <div class="page-header">
            <h1 class="page-title">My Locations</h1>
            <p class="page-subtitle">Manage your sensor network across all locations</p>
        </div>

        <div class="grid-layout">
            <div class="map-container">
                <div id="map"></div>
            </div>

            <div class="sidebar">
                <div class="stats-grid">
                    <div class="stat-card online">
                        <div class="stat-value" id="statOnline">—</div>
                        <div class="stat-label">Online</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="statTotal">—</div>
                        <div class="stat-label">Total Sensors</div>
                    </div>
                    <div class="stat-card warning">
                        <div class="stat-value" id="statWarning">—</div>
                        <div class="stat-label">Warning</div>
                    </div>
                    <div class="stat-card offline">
                        <div class="stat-value" id="statOffline">—</div>
                        <div class="stat-label">Offline</div>
                    </div>
                </div>

                <div class="devices-panel">
                    <div class="panel-header">
                        <span class="panel-title">Your Sensors</span>
                    </div>
                    <div class="devices-list" id="devicesList">
                        <div class="loading"><div class="spinner"></div> Loading...</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Device Health Section -->
        <div class="health-section">
            <div class="section-header">
                <h2 class="section-title">Device Health</h2>
            </div>
            <div class="health-grid" id="healthGrid">
                <div class="loading"><div class="spinner"></div> Loading device health...</div>
            </div>
        </div>

        <footer class="footer">
            Powered by DataJam • API v1.6.0 • Updates every 2 minutes
        </footer>
    </div>

    <div id="modal"></div>

    <script>
        const API_BASE = '/.netlify/functions/nbiot-api';
        let map;
        let markers = [];

        // Quality Status: derived from raw quality fields
        function getQualityStatus(of, cd, sf) {
            of = of || 0;
            cd = cd || 0;
            sf = sf || 0;

            if (of > 0 || sf > 3) return { status: 'DEGRADED', class: 'degraded' };
            if (cd > 0) return { status: 'CATCHING UP', class: 'catching-up' };
            return { status: 'OK', class: 'ok' };
        }

        function initMap() {
            map = L.map('map', {
                zoomControl: true,
                attributionControl: false
            }).setView([34.0195, -118.4912], 12);

            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                maxZoom: 19
            }).addTo(map);
        }

        function getMarkerIcon(status) {
            const colors = {
                online: '#15E0BC',
                warning: '#EDBA06',
                offline: '#E94B52'
            };
            const color = colors[status] || colors.offline;

            return L.divIcon({
                className: 'custom-marker',
                html: `<div style="
                    width: 24px;
                    height: 24px;
                    background: ${color};
                    border-radius: 50%;
                    border: 3px solid white;
                    box-shadow: 0 2px 8px rgba(0,0,0,0.3);
                "></div>`,
                iconSize: [24, 24],
                iconAnchor: [12, 12]
            });
        }

        function updateMap(devices) {
            // Clear existing markers
            markers.forEach(m => map.removeLayer(m));
            markers = [];

            const bounds = [];

            devices.filter(d => d.latitude && d.longitude).forEach(device => {
                const marker = L.marker([device.latitude, device.longitude], {
                    icon: getMarkerIcon(device.connection_status)
                }).addTo(map);

                marker.bindPopup(`
                    <div style="font-family: Poppins, sans-serif; min-width: 150px;">
                        <strong style="font-size: 14px;">${device.location_name || device.device_id}</strong><br>
                        <span style="color: #888; font-size: 12px;">Status: ${device.connection_status}</span><br>
                        <span style="color: #888; font-size: 12px;">Signal: ${device.last_signal_dbm || '—'} dBm</span>
                    </div>
                `);

                markers.push(marker);
                bounds.push([device.latitude, device.longitude]);
            });

            if (bounds.length > 0) {
                map.fitBounds(bounds, { padding: [50, 50], maxZoom: 14 });
            }
        }

        function updateStats(stats) {
            document.getElementById('statTotal').textContent = stats.total || 0;
            document.getElementById('statOnline').textContent = stats.online || 0;
            document.getElementById('statWarning').textContent = stats.warning || 0;
            document.getElementById('statOffline').textContent = stats.offline || 0;
        }

        function getSignalQuality(dbm) {
            if (!dbm || dbm <= -999) return { label: 'Unknown', class: '', percent: 0 };
            if (dbm >= -65) return { label: 'Excellent', class: 'good', percent: 100 };
            if (dbm >= -75) return { label: 'Good', class: 'good', percent: 75 };
            if (dbm >= -85) return { label: 'Fair', class: 'warn', percent: 50 };
            return { label: 'Poor', class: 'bad', percent: 25 };
        }

        function getSignalColor(dbm) {
            if (!dbm || dbm <= -999) return '#5A5856';
            if (dbm >= -65) return '#15E0BC';
            if (dbm >= -75) return '#78C534';
            if (dbm >= -85) return '#EDBA06';
            return '#E94B52';
        }

        function updateHealthGrid(devices) {
            const grid = document.getElementById('healthGrid');
            const jbnbDevices = devices.filter(d => d.device_id.startsWith('JBNB'));

            if (jbnbDevices.length === 0) {
                grid.innerHTML = '<div style="padding: 24px; text-align: center; color: var(--text-muted);">No devices configured</div>';
                return;
            }

            grid.innerHTML = jbnbDevices.map(d => {
                const signal = getSignalQuality(d.last_signal_dbm);
                const signalColor = getSignalColor(d.last_signal_dbm);

                return `
                    <div class="health-card">
                        <div class="health-card-header">
                            <div class="health-device-info">
                                <div class="health-status-dot ${d.connection_status}"></div>
                                <div>
                                    <div class="health-device-name">${d.location_name || d.device_id}</div>
                                    <div class="health-device-id">${d.device_id}</div>
                                </div>
                            </div>
                            <div class="health-badge ${d.connection_status}">${d.connection_status}</div>
                        </div>
                        <div class="health-metrics">
                            <div class="health-metric">
                                <div class="health-metric-label">Firmware</div>
                                <div class="health-metric-value">v${d.firmware_version || '—'}</div>
                            </div>
                            <div class="health-metric">
                                <div class="health-metric-label">Last Seen</div>
                                <div class="health-metric-value ${d.connection_status === 'online' ? 'good' : d.connection_status === 'warning' ? 'warn' : 'bad'}">${d.last_seen_ago || 'Never'}</div>
                            </div>
                            <div class="health-metric">
                                <div class="health-metric-label">Signal Strength</div>
                                <div class="health-metric-value ${signal.class}">${d.last_signal_dbm ? d.last_signal_dbm + ' dBm' : '—'}</div>
                                <div class="signal-bar">
                                    <div class="signal-bar-fill" style="width: ${signal.percent}%; background: ${signalColor};"></div>
                                </div>
                            </div>
                            <div class="health-metric">
                                <div class="health-metric-label">Signal Quality</div>
                                <div class="health-metric-value ${signal.class}">${signal.label}</div>
                            </div>
                        </div>
                        ${d.location_name ? `
                            <div class="health-location">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/>
                                    <circle cx="12" cy="10" r="3"/>
                                </svg>
                                ${d.location_name}
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
        }

        function updateDevicesList(devices) {
            const list = document.getElementById('devicesList');
            const jbnbDevices = devices.filter(d => d.device_id.startsWith('JBNB'));

            if (jbnbDevices.length === 0) {
                list.innerHTML = '<div style="padding: 24px; text-align: center; color: var(--text-muted);">No sensors configured</div>';
                return;
            }

            list.innerHTML = jbnbDevices.map(d => `
                <div class="device-item" onclick="showDeviceDetail('${d.device_id}')">
                    <div class="device-info">
                        <div class="device-status ${d.connection_status}"></div>
                        <div>
                            <div class="device-name">${d.location_name || d.device_id}</div>
                            <div class="device-meta">${d.device_id}</div>
                        </div>
                    </div>
                    <div class="device-stats">
                        <div class="device-signal">${d.last_signal_dbm ? d.last_signal_dbm + ' dBm' : '—'}</div>
                        <div class="device-seen">${d.last_seen_ago || 'Never'}</div>
                    </div>
                </div>
            `).join('');
        }

        // Current device config cache
        let currentDeviceConfig = null;

        async function showDeviceDetail(deviceId) {
            const modal = document.getElementById('modal');
            modal.innerHTML = `
                <div class="modal-overlay" onclick="if(event.target===this)closeModal()">
                    <div class="modal">
                        <div class="modal-header">
                            <div class="modal-title">Loading...</div>
                            <button class="modal-close" onclick="closeModal()">×</button>
                        </div>
                        <div class="modal-body">
                            <div class="loading"><div class="spinner"></div></div>
                        </div>
                    </div>
                </div>
            `;

            try {
                // Fetch device data and config in parallel
                const [deviceRes, configRes] = await Promise.all([
                    fetch(`${API_BASE}/device/${deviceId}`),
                    fetch(`${API_BASE}/device/${deviceId}/config`)
                ]);
                const data = await deviceRes.json();
                const config = await configRes.json();
                currentDeviceConfig = config;

                const { device, recent_readings } = data;

                const todayReadings = recent_readings.filter(r =>
                    new Date(r.timestamp).toDateString() === new Date().toDateString()
                );

                const todayImpressions = todayReadings.reduce((sum, r) => sum + (r.impressions || 0), 0);
                const todayUnique = todayReadings.reduce((sum, r) => sum + (r.unique_count || 0), 0);
                const todayBleUnique = todayReadings.reduce((sum, r) => sum + (r.ble_unique || 0), 0);
                const todayBleApple = todayReadings.reduce((sum, r) => sum + (r.ble_apple || 0), 0);
                const todayOverflow = todayReadings.reduce((sum, r) => sum + (r.overflow_count || 0), 0);

                modal.innerHTML = `
                    <div class="modal-overlay" onclick="if(event.target===this)closeModal()">
                        <div class="modal">
                            <div class="modal-header">
                                <div class="modal-title">${device.location_name || device.device_id}</div>
                                <button class="modal-close" onclick="closeModal()">×</button>
                            </div>
                            <div class="modal-tabs">
                                <button class="modal-tab active" onclick="switchTab('activity', this)">Activity</button>
                                <button class="modal-tab" onclick="switchTab('settings', this)">Settings</button>
                            </div>
                            <div class="modal-body">
                                <!-- Activity Tab -->
                                <div id="tab-activity" class="tab-content active">
                                    <div class="modal-stats">
                                        <div class="modal-stat">
                                            <div class="modal-stat-value">${todayImpressions.toLocaleString()}</div>
                                            <div class="modal-stat-label">Impressions</div>
                                        </div>
                                        <div class="modal-stat">
                                            <div class="modal-stat-value">${todayUnique.toLocaleString()}</div>
                                            <div class="modal-stat-label">Unique</div>
                                        </div>
                                        <div class="modal-stat">
                                            <div class="modal-stat-value">${device.last_signal_dbm || '—'}</div>
                                            <div class="modal-stat-label">Signal</div>
                                        </div>
                                    </div>
                                    <div class="modal-stats" style="margin-top: 8px;">
                                        <div class="modal-stat">
                                            <div class="modal-stat-value">${todayBleUnique > 0 ? Math.round((todayBleApple / todayBleUnique) * 100) : 0}%</div>
                                            <div class="modal-stat-label">Apple</div>
                                        </div>
                                        <div class="modal-stat">
                                            <div class="modal-stat-value">${todayBleUnique > 0 ? Math.round(((todayBleUnique - todayBleApple) / todayBleUnique) * 100) : 0}%</div>
                                            <div class="modal-stat-label">Other</div>
                                        </div>
                                        <div class="modal-stat">
                                            <div class="modal-stat-value" style="color: ${todayOverflow > 0 ? 'var(--dj-orange)' : 'var(--chart-teal)'}">${todayOverflow}</div>
                                            <div class="modal-stat-label">Overflow</div>
                                        </div>
                                    </div>

                                    <div style="margin: 16px 0;">
                                        <div style="font-size: 12px; font-weight: 500; color: var(--text-muted); margin-bottom: 8px;">Recent Activity</div>
                                        <div class="readings-list">
                                            ${recent_readings.length === 0
                                                ? '<div style="padding: 16px; text-align: center; color: var(--text-muted);">No data yet</div>'
                                                : recent_readings.slice(0, 10).map(r => {
                                                    const bleU = r.ble_unique || 0;
                                                    const bleA = r.ble_apple || 0;
                                                    const applePct = bleU > 0 ? Math.round((bleA / bleU) * 100) : 0;
                                                    const otherPct = bleU > 0 ? 100 - applePct : 0;
                                                    const qs = getQualityStatus(r.overflow_count, r.cache_depth, r.send_failures);
                                                    return `
                                                    <div class="reading-row" style="flex-direction: column; align-items: flex-start; gap: 6px;">
                                                        <div style="display: flex; justify-content: space-between; width: 100%; align-items: center;">
                                                            <div style="display: flex; align-items: center; gap: 8px;">
                                                                <span class="reading-time">${new Date(r.timestamp).toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'})}</span>
                                                                <span class="quality-status ${qs.class}">${qs.status}</span>
                                                            </div>
                                                            <span class="reading-value">${r.impressions} / ${r.unique_count || 0}</span>
                                                        </div>
                                                        <div style="display: flex; justify-content: space-between; width: 100%; font-size: 11px; color: var(--text-secondary);">
                                                            <span>Apple ${applePct}% / Other ${otherPct}%</span>
                                                            <span>${r.signal_dbm || '—'}dBm</span>
                                                        </div>
                                                    </div>
                                                `}).join('')
                                            }
                                        </div>
                                    </div>

                                    <div class="command-buttons">
                                        <button class="cmd-btn send" onclick="sendCommand('${device.device_id}', 'send_now', this)">
                                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"/>
                                            </svg>
                                            Send Now
                                        </button>
                                        <button class="cmd-btn locate" onclick="sendCommand('${device.device_id}', 'geolocate', this)">
                                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <circle cx="12" cy="12" r="10"/>
                                                <path d="M12 2v4M12 18v4M2 12h4M18 12h4"/>
                                            </svg>
                                            Geolocate
                                        </button>
                                        <button class="cmd-btn reboot" onclick="sendCommand('${device.device_id}', 'reboot', this)">
                                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <path d="M1 4v6h6M23 20v-6h-6"/>
                                                <path d="M20.49 9A9 9 0 0 0 5.64 5.64L1 10m22 4l-4.64 4.36A9 9 0 0 1 3.51 15"/>
                                            </svg>
                                            Reboot
                                        </button>
                                    </div>

                                    <div style="padding-top: 16px; border-top: 1px solid rgba(255,255,255,0.06); font-size: 12px; color: var(--text-muted);">
                                        <div>Device ID: ${device.device_id}</div>
                                        <div>Firmware: v${device.firmware_version || '—'}</div>
                                        ${device.latitude ? `<div>Location: ${device.latitude.toFixed(4)}, ${device.longitude.toFixed(4)}</div>` : ''}
                                    </div>
                                </div>

                                <!-- Settings Tab -->
                                <div id="tab-settings" class="tab-content">
                                    <div class="settings-section">
                                        <div class="settings-section-title">
                                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <circle cx="12" cy="12" r="3"/>
                                                <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/>
                                            </svg>
                                            Report Interval
                                        </div>
                                        <div class="setting-row">
                                            <div>
                                                <div class="setting-label">Data Reporting Frequency</div>
                                                <div class="setting-sublabel">How often the device sends data</div>
                                            </div>
                                            <select id="cfg-interval" class="settings-select" onchange="updateIntervalDisplay()">
                                                <option value="60000" ${config.report_interval_ms === 60000 ? 'selected' : ''}>1 minute</option>
                                                <option value="300000" ${config.report_interval_ms === 300000 ? 'selected' : ''}>5 minutes</option>
                                                <option value="600000" ${config.report_interval_ms === 600000 ? 'selected' : ''}>10 minutes</option>
                                                <option value="900000" ${config.report_interval_ms === 900000 ? 'selected' : ''}>15 minutes</option>
                                                <option value="1800000" ${config.report_interval_ms === 1800000 ? 'selected' : ''}>30 minutes</option>
                                                <option value="3600000" ${config.report_interval_ms === 3600000 ? 'selected' : ''}>60 minutes</option>
                                            </select>
                                        </div>
                                    </div>

                                    <div class="settings-section">
                                        <div class="settings-section-title">
                                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/>
                                                <circle cx="12" cy="10" r="3"/>
                                            </svg>
                                            Distance Zones (RSSI Thresholds)
                                        </div>
                                        <div class="setting-row">
                                            <div>
                                                <div class="setting-label">At Counter</div>
                                                <div class="setting-sublabel">Very close range (0-2m)</div>
                                            </div>
                                            <div class="setting-value">
                                                <input type="range" class="range-slider" id="cfg-rssi-imm" min="-60" max="-30" value="${config.rssi_immediate_threshold || -50}" oninput="updateSliderDisplay(this, 'rssi-imm-val', 'dBm')">
                                                <span class="setting-value-display" id="rssi-imm-val">${config.rssi_immediate_threshold || -50} dBm</span>
                                            </div>
                                        </div>
                                        <div class="setting-row">
                                            <div>
                                                <div class="setting-label">In Store</div>
                                                <div class="setting-sublabel">Near range (2-5m)</div>
                                            </div>
                                            <div class="setting-value">
                                                <input type="range" class="range-slider" id="cfg-rssi-near" min="-75" max="-50" value="${config.rssi_near_threshold || -65}" oninput="updateSliderDisplay(this, 'rssi-near-val', 'dBm')">
                                                <span class="setting-value-display" id="rssi-near-val">${config.rssi_near_threshold || -65} dBm</span>
                                            </div>
                                        </div>
                                        <div class="setting-row">
                                            <div>
                                                <div class="setting-label">Window Shopping</div>
                                                <div class="setting-sublabel">Far range (5-15m)</div>
                                            </div>
                                            <div class="setting-value">
                                                <input type="range" class="range-slider" id="cfg-rssi-far" min="-90" max="-65" value="${config.rssi_far_threshold || -80}" oninput="updateSliderDisplay(this, 'rssi-far-val', 'dBm')">
                                                <span class="setting-value-display" id="rssi-far-val">${config.rssi_far_threshold || -80} dBm</span>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="settings-section">
                                        <div class="settings-section-title">
                                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <circle cx="12" cy="12" r="10"/>
                                                <polyline points="12 6 12 12 16 14"/>
                                            </svg>
                                            Engagement Buckets (Dwell Time)
                                        </div>
                                        <div class="setting-row">
                                            <div>
                                                <div class="setting-label">Quick Glance</div>
                                                <div class="setting-sublabel">0 to X minutes</div>
                                            </div>
                                            <div class="setting-value">
                                                <input type="range" class="range-slider" id="cfg-dwell-short" min="1" max="5" value="${config.dwell_short_threshold || 1}" oninput="updateSliderDisplay(this, 'dwell-short-val', 'min')">
                                                <span class="setting-value-display" id="dwell-short-val">${config.dwell_short_threshold || 1} min</span>
                                            </div>
                                        </div>
                                        <div class="setting-row">
                                            <div>
                                                <div class="setting-label">Browsing</div>
                                                <div class="setting-sublabel">X to Y minutes</div>
                                            </div>
                                            <div class="setting-value">
                                                <input type="range" class="range-slider" id="cfg-dwell-medium" min="2" max="15" value="${config.dwell_medium_threshold || 5}" oninput="updateSliderDisplay(this, 'dwell-medium-val', 'min')">
                                                <span class="setting-value-display" id="dwell-medium-val">${config.dwell_medium_threshold || 5} min</span>
                                            </div>
                                        </div>
                                        <div class="setting-row">
                                            <div>
                                                <div class="setting-label">Shopping</div>
                                                <div class="setting-sublabel">Y to Z minutes</div>
                                            </div>
                                            <div class="setting-value">
                                                <input type="range" class="range-slider" id="cfg-dwell-long" min="5" max="30" value="${config.dwell_long_threshold || 10}" oninput="updateSliderDisplay(this, 'dwell-long-val', 'min')">
                                                <span class="setting-value-display" id="dwell-long-val">${config.dwell_long_threshold || 10} min</span>
                                            </div>
                                        </div>
                                    </div>

                                    <button class="save-btn" id="save-config-btn" onclick="saveDeviceConfig('${device.device_id}')">
                                        Save Configuration
                                    </button>
                                    <div class="config-version">Config version: ${config.config_version || 1}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

            } catch (err) {
                modal.innerHTML = '';
                alert('Failed to load device details');
            }
        }

        function switchTab(tabName, btn) {
            // Update tab buttons
            document.querySelectorAll('.modal-tab').forEach(t => t.classList.remove('active'));
            btn.classList.add('active');

            // Update tab content
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.getElementById(`tab-${tabName}`).classList.add('active');
        }

        function updateSliderDisplay(slider, displayId, unit) {
            document.getElementById(displayId).textContent = `${slider.value} ${unit}`;
        }

        function updateIntervalDisplay() {
            // No-op for dropdown, value is direct
        }

        async function saveDeviceConfig(deviceId) {
            const btn = document.getElementById('save-config-btn');
            const originalText = btn.textContent;
            btn.disabled = true;
            btn.textContent = 'Saving...';

            const config = {
                report_interval_ms: parseInt(document.getElementById('cfg-interval').value),
                rssi_immediate_threshold: parseInt(document.getElementById('cfg-rssi-imm').value),
                rssi_near_threshold: parseInt(document.getElementById('cfg-rssi-near').value),
                rssi_far_threshold: parseInt(document.getElementById('cfg-rssi-far').value),
                dwell_short_threshold: parseInt(document.getElementById('cfg-dwell-short').value),
                dwell_medium_threshold: parseInt(document.getElementById('cfg-dwell-medium').value),
                dwell_long_threshold: parseInt(document.getElementById('cfg-dwell-long').value)
            };

            // Client-side validation
            if (config.rssi_immediate_threshold <= config.rssi_near_threshold ||
                config.rssi_near_threshold <= config.rssi_far_threshold) {
                alert('RSSI thresholds must be in order: At Counter > In Store > Window Shopping');
                btn.disabled = false;
                btn.textContent = originalText;
                return;
            }

            if (config.dwell_short_threshold >= config.dwell_medium_threshold ||
                config.dwell_medium_threshold >= config.dwell_long_threshold) {
                alert('Dwell thresholds must be in order: Quick Glance < Browsing < Shopping');
                btn.disabled = false;
                btn.textContent = originalText;
                return;
            }

            try {
                const res = await fetch(`${API_BASE}/device/${deviceId}/config`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(config)
                });

                const data = await res.json();

                if (res.ok) {
                    btn.classList.add('success');
                    btn.textContent = 'Saved!';
                    // Update version display
                    if (data.config_version) {
                        document.querySelector('.config-version').textContent = `Config version: ${data.config_version}`;
                    }
                    setTimeout(() => {
                        btn.classList.remove('success');
                        btn.textContent = originalText;
                        btn.disabled = false;
                    }, 2000);
                } else {
                    throw new Error(data.error || 'Failed to save');
                }
            } catch (err) {
                alert(`Failed to save: ${err.message}`);
                btn.disabled = false;
                btn.textContent = originalText;
            }
        }

        function closeModal() {
            document.getElementById('modal').innerHTML = '';
        }

        async function sendCommand(deviceId, command, btn) {
            const originalText = btn.innerHTML;
            btn.classList.add('loading');
            btn.innerHTML = '<div class="spinner" style="width:14px;height:14px;margin:0;border-width:2px;"></div>';

            try {
                const res = await fetch(`${API_BASE}/device/${deviceId}/command`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ command })
                });

                const data = await res.json();

                if (res.ok) {
                    btn.classList.remove('loading');
                    btn.classList.add('success');
                    btn.innerHTML = '✓ Sent';

                    setTimeout(() => {
                        btn.classList.remove('success');
                        btn.innerHTML = originalText;
                    }, 2000);
                } else {
                    throw new Error(data.error || 'Command failed');
                }
            } catch (err) {
                btn.classList.remove('loading');
                btn.innerHTML = originalText;
                alert(`Failed: ${err.message}`);
            }
        }

        async function loadFleet() {
            try {
                const res = await fetch(`${API_BASE}/devices`);
                const data = await res.json();

                updateStats(data.stats || {});
                updateDevicesList(data.devices || []);
                updateMap(data.devices || []);
                updateHealthGrid(data.devices || []);

            } catch (err) {
                console.error('Failed to load fleet:', err);
            }
        }

        initMap();
        loadFleet();
        setInterval(loadFleet, 120000);
    </script>
</body>
</html>
